var We=Object.defineProperty;var Ve=(s,e,t)=>e in s?We(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var o=(s,e,t)=>Ve(s,typeof e!="symbol"?e+"":e,t);import{bi as Ye,t as l,bj as Ke,bk as qe,bl as Je,bm as je,bn as ze,bo as Qe,bp as Xe,bq as Ze,br as et,b3 as U,Q as m,bs as me,ae as b,bt as tt,bu as st,bv as P,bw as it,bx as rt,by as at,bz as De,a8 as J,bA as ce,bB as ot,bC as nt,r as pe,bb as ct,S as j,b as he,c as ht,C as f,b2 as H,R as T,bD as lt,b5 as Ee,bE as dt,bF as X,bG as Le,ak as ut,ar as mt,aw as le,aq as pt,aB as gt,bH as u,aS as z,aA as K,bI as F,bJ as W,bK as Z,bL as St,J as p,a0 as de,bM as ft,aE as Re,bN as Ie,aL as Et,N as G,f as ge,M as Rt,ad as R,L as Ge,bO as It,H as k,bP as _t,bQ as _e,bR as Mt,a$ as Me,af as w,bS as yt,bT as Tt,bU as bt,b0 as At,bV as ye,bW as Te,W as q,ac as Nt,w as vt,bX as E}from"./HorizontalSelector-DF3fU9DK.js";function be(s){return s instanceof Ye?new Error(`${l.invalidPieceName}: ${s.data}`):s instanceof Ke?new Error(`${l.invalidTurn}: ${s.data}`):s instanceof qe?new Error(`${l.invalidMove}: ${s.data}`):s instanceof Je?new Error(`${l.invalidMoveNumber}: ${s.data}`):s instanceof je?new Error(`${l.invalidDestination}: ${s.data}`):s instanceof ze?new Error(`${l.pieceNotExists}: ${s.data}`):s instanceof Qe?new Error(`${l.invalidLine}: ${s.data}`):s instanceof Xe?new Error(`${l.invalidBoard}: ${s.data}`):s instanceof Ze?new Error(`${l.invalidHandPiece}: ${s.data}`):s instanceof et?new Error(`${l.invalidUSI}: ${s.data}`):s}let V;function Ue(s){if(V)return;const e=(s==null?void 0:s.type)||"sine",t=(s==null?void 0:s.frequency)||440,i=(s==null?void 0:s.volume)||2,r=new AudioContext,a=r.createOscillator(),c=r.createGain();a.connect(c),c.connect(r.destination),a.type=e,a.frequency.value=t,c.gain.value=i*.005,a.onended=()=>{c.disconnect(r.destination),a.disconnect(c)},a.start(r.currentTime),s!=null&&s.time&&a.stop(r.currentTime+s.time),s!=null&&s.time||(V=a)}function wt(s){Ue({type:"sine",frequency:s.frequency,time:.1,volume:s.volume})}function Ct(s){Ue({type:"sine",frequency:s.frequency,volume:s.volume})}function Ae(){V&&(V.stop(),V=void 0)}let ee;function te(s){const e=Date.now();if(ee&&e<ee+200)return;const t=new Audio("sound/piece.mp3");t.volume=s*.01,t.play(),ee=e}function Ot(s){return s>=1500?"先手勝勢":s>=600?"先手優勢":s>=400?"先手有利":s>=200?"先手有望":s>=-200?"互角":s>=-400?"後手有望":s>=-600?"後手有利":s>=-1500?"後手優勢":"後手勝勢"}function Ne(s,e){return 100/(1+Math.exp(-s/e))}const Se=1e4;function Pt(s,e){const t=[],i=s.clone();for(const r of e){const a=i.createMoveByUSI(r);if(!a||!i.doMove(a))break;t.push(a)}return t}function kt(s){const e=Math.floor(s/60),t=s%60;return String(e).padStart(2,"0")+":"+String(t).padStart(2,"0")}var M=(s=>(s[s.PLAYER=0]="PLAYER",s[s.OPPONENT=1]="OPPONENT",s[s.RESEARCHER=2]="RESEARCHER",s[s.RESEARCHER_2=3]="RESEARCHER_2",s[s.RESEARCHER_3=4]="RESEARCHER_3",s[s.RESEARCHER_4=5]="RESEARCHER_4",s))(M||{});function Dt(s){const e=/^\*詰み=(先手勝ち|後手勝ち)(?::([0-9]+)手)?/.exec(s);if(e)return Number(e[2]||Se)*(e[1]==="先手勝ち"?1:-1)}function Lt(s){const e=/^#詰み=(先手勝ち|後手勝ち)(?::([0-9]+)手)?/.exec(s);if(e)return Number(e[2]||Se)*(e[1]==="先手勝ち"?1:-1)}function Gt(s){const e=/^\*評価値=([+-]?[.0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Ut(s){const e=/^#評価値=([+-]?[.0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Bt(s){const e=/^\* *([+-]?[.0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Ht(s){const e=/^\*対局 .* 評価値 ([+-]?[0-9]+)/.exec(s);return e?Number(e[1]):void 0}function Ft(s){const e=/^\*解析 .* 評価値 ([+-]?[0-9]+)/.exec(s);return e?Number(e[1]):void 0}function xt(s){const e=/^\* .* 評価値 ([+-]?[0-9]+)/.exec(s);return e?Number(e[1]):void 0}function $t(s){const e=/^#(?:形勢|指し手)\[([+-]?[0-9]+)\]/.exec(s);return e?Number(e[1]):void 0}function ve(s){s.forEach(e=>{const t=e.customData||{},i=e.comment.split(`
`);for(const r of i){const a=Dt(r);a!==void 0&&(t.playerSearchInfo={...t.playerSearchInfo,mate:a});const c=Lt(r);c!==void 0&&(t.researchInfo={...t.researchInfo,mate:c});const h=Gt(r)||Bt(r)||Ht(r);h!==void 0&&(t.playerSearchInfo={...t.playerSearchInfo,score:h});const S=Ut(r)||Ft(r)||xt(r)||$t(r);S!==void 0&&(t.researchInfo={...t.researchInfo,score:S})}e.customData=t})}function Wt(s,e,t,i){const r=e===0?"*":"#";let a="";if(t.mate){const c=t.mate>=0?"先手勝ち":"後手勝ち";a+=`${r}詰み=${c}`,Math.abs(t.mate)!==Se&&(a+=`:${Math.abs(t.mate)}手`),a+=`
`}return t.score!==void 0&&(a+=Ot(t.score)+`
`,a+=`${r}評価値=${t.score}
`),t.pv&&t.pv.length!==0&&(a+=`${r}読み筋=${dt(s,t.pv)}
`),t.depth&&(a+=`${r}深さ=${t.depth}
`),t.nodes&&(a+=`${r}ノード数=${t.nodes}
`),a&&(i!=null&&i.engineName)&&(a+=`${r}エンジン=${i.engineName}
`),a}function Vt(s,e){const t=e.indexOf(" ",e.indexOf(" ")+1)+1,i=[],r=s.clone();for(let a=t;a<e.length;a+=8){const c=e.substring(a,a+7),h=Le(r,c);if(h instanceof Error||!r.doMove(h,{ignoreValidation:!1}))break;i.push(h)}return i}function Yt(s,e){const t=[];for(const i of e.split(`
`)){let r;if(i.match(/^[#*]読み筋=/))r=X(s,i.substring(5));else if(i.match(/^\*.* 読み筋 /)){const a=i.substring(i.indexOf(" 読み筋 ")+5),c=s.color===f.BLACK?"▲":"△";r=X(s,a.substring(a.indexOf(c)))}else if(i.match(/^#(?:指し手|形勢)\[/)){const a=i.substring(i.indexOf("]")+1),c=s.color===f.BLACK?"▲":"△";r=X(s,a.substring(a.indexOf(c)))}else i.match(/^\* -?[0-9]+ /)&&(r=Vt(s,i));r!=null&&r.length&&t.push(r)}return t}function Kt(s){return s.timeSeconds+"+"+s.byoyomi+"+"+s.increment}function qt(s){return kt(s.timeSeconds)+"+"+String(s.byoyomi).padStart(2,"0")}class Jt{constructor(e=new U){o(this,"_recordFilePath");o(this,"_unsaved",!1);o(this,"_sourceURL");o(this,"changePositionHandler",null);o(this,"updateTreeHandler",null);o(this,"updateCustomDataHandler",null);o(this,"backupHandler",null);this._record=e,this.bindRecordHandlers()}get record(){return this._record}get recordFilePath(){return this._recordFilePath}get unsaved(){return this._unsaved}get sourceURL(){return this._sourceURL}updateRecordFilePath(e){this._unsaved=!1,e!==this._recordFilePath&&(this._recordFilePath=e,e&&m.addRecordFileHistory(e))}async saveBackup(){if(!this.unsaved)return;const e=this.onBackup(),t=me(this.record,e||{});await m.saveRecordFileBackup(t)}saveBackupOnBackground(){this.saveBackup().catch(e=>{m.log(b.ERROR,`RecordManager#saveBackupOnBackground: failed to save backup: ${e}`)})}clearRecord(e){this.saveBackupOnBackground(),this._record.clear(e),this._unsaved=!1,this._recordFilePath=void 0,this._sourceURL=void 0,this.onChangePosition(),this.onUpdateTree()}replaceRecord(e,t){this.saveBackupOnBackground(),this._record=e,this.bindRecordHandlers(),this.updateRecordFilePath(t==null?void 0:t.path),this._unsaved=!(t!=null&&t.markAsSaved),this._sourceURL=void 0,ve(this._record),this.onChangePosition(),this.onUpdateTree()}reset(){this.clearRecord()}resetByInitialPositionType(e){this.resetBySFEN(tt(e))}resetBySFEN(e){const t=new J;return t.resetBySFEN(e)?(this.clearRecord(t),!0):!1}resetByUSEN(e,t,i){const r=U.newByUSEN(e,t,i);if(r instanceof Error)return r;this.replaceRecord(r,{markAsSaved:!0})}resetByCurrentPosition(){this.clearRecord(this._record.position)}parseRecordData(e,t){let i;switch(t||st(e)){case P.SFEN:{const r=J.newBySFEN(e);i=r?new U(r):new Error(l.failedToParseSFEN);break}case P.USI:i=U.newByUSI(e);break;case P.KIF:i=De(e);break;case P.KI2:i=at(e);break;case P.CSA:i=rt(e);break;case P.JKF:i=it(e);break;case P.USEN:i=U.newByUSEN(e);break;default:i=new Error(l.failedToDetectRecordFormat);break}return i instanceof Error?be(i):i}importRecord(e,t){const i=this.parseRecordData(e,t==null?void 0:t.type);if(i instanceof Error)return i;this.replaceRecord(i,t)}importRecordFromBuffer(e,t,i){const r=ce(t);if(!r)return new Error(`${l.unknownFileExtension}: ${t}`);const a=ot(e,r,i);if(a instanceof Error)return be(a);this.replaceRecord(a,{path:t,markAsSaved:!0})}async importRecordFromRemoteURL(e){const t=!e;if(e=e||this._sourceURL,!e){m.log(b.ERROR,"RecordManager#importRecordFromRemoteURL: source URL is not set");return}const i=await m.loadRemoteRecordFile(e),r=this.parseRecordData(i);if(r instanceof Error)throw r;t?this.mergeRecord(r):this.replaceRecord(r),this._sourceURL=e}exportRecordAsBuffer(e,t){const i=ce(e);if(!i)return new Error(`${l.unknownFileExtension}: ${e}`);const r=nt(this._record,i,t);return this.updateRecordFilePath(e),r}applyPosition(e){this._record.clear(e),this._unsaved=!0,this._recordFilePath=void 0,this.onChangePosition()}swapNextTurn(){const e=this.record.position.clone();e.setColor(pe(e.color)),this.applyPosition(e)}changePosition(e){const t=this.record.position.clone();t.edit(e),this.applyPosition(t)}changePieceSet(e){const t=this.record.position.clone(),i=ct(this.record.position),r={king:e.king-i.king,rook:e.rook-(i.rook+i.dragon),bishop:e.bishop-(i.bishop+i.horse),gold:e.gold-i.gold,silver:e.silver-(i.silver+i.promSilver),knight:e.knight-(i.knight+i.promKnight),lance:e.lance-(i.lance+i.promLance),pawn:e.pawn-(i.pawn+i.promPawn)};Object.entries(r).filter(([,a])=>a<0).forEach(([a,c])=>{const h=a;for(let S=0;S>c;S--){const I=j.all.find(_=>{var v;return((v=t.board.at(_))==null?void 0:v.unpromoted().type)===h});I?t.board.remove(I):h!==he.KING&&(t.blackHand.count(h)>t.whiteHand.count(h)?t.blackHand.reduce(h,1):t.whiteHand.reduce(h,1))}}),Object.entries(r).filter(([,a])=>a>0).forEach(([a,c])=>{const h=a;for(let S=0;S<c;S++){const I=j.all.find(_=>!t.board.at(_));I?t.board.set(I,new ht(f.BLACK,h)):h!==he.KING&&(t.blackHand.count(h)<=t.whiteHand.count(h)?t.blackHand.add(h,1):t.whiteHand.add(h,1))}}),this.applyPosition(t)}goForward(){this._record.goForward()}goBack(){this._record.goBack()}changePly(e){this._record.goto(e)}changeBranch(e){return this._record.switchBranchByIndex(e)}swapWithNextBranch(){return this._record.swapWithNextBranch()?(this._unsaved=!0,!0):!1}swapWithPreviousBranch(){return this._record.swapWithPreviousBranch()?(this._unsaved=!0,!0):!1}removeCurrentMove(){return this._record.removeCurrentMove()?(this._unsaved=!0,this.onUpdateTree(),!0):!1}removeNextMove(){return this._record.removeNextMove()?(this._unsaved=!0,this.onUpdateTree(),!0):!1}jumpToBookmark(e){return this._record.jumpToBookmark(e)}updateComment(e){this._record.current.comment=e,this._unsaved=!0}updateBookmark(e){this._record.current.bookmark=e,this._unsaved=!0}appendComment(e,t){if(!e)return;const i=this._record.current.comment,r=this.record.current.comment?`
`:"";switch(t){case H.NONE:break;case H.INSERT:this._record.current.comment=e+r+i;break;case H.APPEND:this._record.current.comment=i+r+e;break;case H.OVERWRITE:this._record.current.comment=e;break}this._unsaved=!0}appendSearchComment(e,t,i,r){let a=Wt(this.record.position,e,t,r);r!=null&&r.header&&(a=r.header+`
`+a),this.appendComment(a,i),this._unsaved=!0}get inCommentPVs(){return Yt(this.record.position,this.record.current.comment)}setGameStartMetadata(e){e.gameTitle&&this._record.metadata.setStandardMetadata(T.TITLE,e.gameTitle),e.blackName&&this._record.metadata.setStandardMetadata(T.BLACK_NAME,e.blackName),e.whiteName&&this._record.metadata.setStandardMetadata(T.WHITE_NAME,e.whiteName),this._record.metadata.setStandardMetadata(T.DATE,lt()),this._record.metadata.setStandardMetadata(T.START_DATETIME,Ee());const i=e.blackTimeLimit.increment||e.whiteTimeLimit.increment?Kt:qt,r=i(e.blackTimeLimit),a=i(e.whiteTimeLimit);r===a?this._record.metadata.setStandardMetadata(T.TIME_LIMIT,r):(this._record.metadata.setStandardMetadata(T.BLACK_TIME_LIMIT,r),this._record.metadata.setStandardMetadata(T.WHITE_TIME_LIMIT,a)),this._unsaved=!0}setGameEndMetadata(){this._record.metadata.setStandardMetadata(T.END_DATETIME,Ee()),this._unsaved=!0}updateSearchInfo(e,t){var r,a,c,h;const i=this.record.current.customData||{};switch(e){case 0:i.playerSearchInfo=t;break;case 1:i.opponentSearchInfo=t;break;case 2:(t.depth||0)>=(((r=i.researchInfo)==null?void 0:r.depth)||0)&&(i.researchInfo=t);break;case 3:(t.depth||0)>=(((a=i.researchInfo2)==null?void 0:a.depth)||0)&&(i.researchInfo2=t);break;case 4:(t.depth||0)>=(((c=i.researchInfo3)==null?void 0:c.depth)||0)&&(i.researchInfo3=t);break;case 5:(t.depth||0)>=(((h=i.researchInfo4)==null?void 0:h.depth)||0)&&(i.researchInfo4=t);break}this._record.current.customData=i,this.onUpdateCustomData()}appendMove(e){return this._record.append(e.move,e.moveOption)?(e.elapsedMs!==void 0&&this._record.current.setElapsedMs(e.elapsedMs),this._unsaved=!0,!0):!1}appendMovesSilently(e,t){this.unbindRecordHandlers();try{let i=0;const r=this._record.current.ply;for(const a of e){if(!this._record.append(a,t))break;i++}return this._record.goto(r),this._unsaved=!0,this.onUpdateTree(),i}finally{this.bindRecordHandlers()}}mergeRecord(e){this._record.merge(e),this._unsaved=!0,ve(this._record),this.onUpdateTree()}updateStandardMetadata(e){this._record.metadata.setStandardMetadata(e.key,e.value),this._unsaved=!0}on(e,t){switch(e){case"changePosition":this.changePositionHandler=t;break;case"updateTree":this.updateTreeHandler=t;break;case"updateCustomData":this.updateCustomDataHandler=t;break;case"backup":this.backupHandler=t;break}return this}onChangePosition(){this.changePositionHandler&&this.changePositionHandler()}onUpdateTree(){this.updateTreeHandler&&this.updateTreeHandler()}onUpdateCustomData(){this.updateCustomDataHandler&&this.updateCustomDataHandler()}onBackup(){return this.backupHandler?this.backupHandler():null}bindRecordHandlers(){this._record.on("changePosition",this.onChangePosition.bind(this))}unbindRecordHandlers(){this._record.on("changePosition",()=>{})}}class jt{constructor(){o(this,"searchHandler")}isEngine(){return!1}async readyNewGame(){}async startSearch(e,t,i,r){this.searchHandler=r}async startPonder(){}async startMateSearch(){}async stop(){}async gameover(){}async close(){this.searchHandler=void 0}doMove(e){const t=this.searchHandler;this.searchHandler=void 0,t==null||t.onMove(e)}resign(){const e=this.searchHandler;this.searchHandler=void 0,e==null||e.onResign()}win(){const e=this.searchHandler;this.searchHandler=void 0,e==null||e.onWin()}}const ue=new jt;let fe=()=>{},Be=()=>{};function zt(s){fe=s}function Qt(s){Be=s}class Y{constructor(e,t,i){o(this,"_sessionID",0);o(this,"usi");o(this,"position");o(this,"searchHandler");o(this,"mateHandler");o(this,"ponder");o(this,"inPonder",!1);o(this,"info");o(this,"usiInfoTimeout");this.engine=e,this.timeoutSeconds=t,this.onSearchInfo=i}get name(){return this.engine.name}get sessionID(){return this._sessionID}async launch(){this._sessionID=await m.usiLaunch(this.engine,this.timeoutSeconds),N[this.sessionID]=this}isEngine(){return!0}async readyNewGame(){await m.usiReady(this.sessionID)}async startSearch(e,t,i,r){this.clearHandlers(),this.searchHandler=r,this.usi=t,this.position=e.clone(),this.inPonder&&this.ponder===this.usi?m.usiPonderHit(this.sessionID,i):(this.info=void 0,await m.usiGo(this.sessionID,this.usi,i)),this.inPonder=!1,this.ponder=void 0}async startPonder(e,t,i){if(ut(this.engine.options[mt])!=="true"||this.inPonder)return;const a=t;if(!this.ponder||!this.ponder.startsWith(a))return;const c=e.createMoveByUSI(this.ponder.slice(a.length+1));!c||!e.isValidMove(c)||(this.clearHandlers(),this.usi=this.ponder,this.position=e.clone(),this.position.doMove(c),this.info=void 0,this.inPonder=!0,await m.usiGoPonder(this.sessionID,this.ponder,i))}async startMateSearch(e,t,i){this.clearHandlers(),this.usi=t,this.info=void 0,this.position=e.clone(),this.mateHandler=i,await m.usiGoMate(this.sessionID,this.usi)}async startResearch(e,t){this.clearHandlers(),this.usi=t,this.info=void 0,this.position=e.clone(),await m.usiGoInfinite(this.sessionID,t)}async stop(){await m.usiStop(this.sessionID)}async gameover(e){await m.usiGameover(this.sessionID,e)}async close(){this.clearHandlers(),await m.usiQuit(this.sessionID),delete N[this.sessionID]}clearHandlers(){this.searchHandler=void 0,this.mateHandler=void 0}onBestMove(e,t,i){var h;const r=this.searchHandler;if(this.clearHandlers(),!r||!this.position||e!==this.usi)return;if(t==="resign"){r.onResign();return}if(t==="win"){r.onWin();return}const a=this.position.createMoveByUSI(t);if(!a){r.onError("エンジンから不明な指し手を受信しました:"+t),r.onResign();return}const c=e.indexOf(" moves ")>0;if(this.ponder=i&&`${e}${c?"":" moves"} ${t} ${i}`,this.flushUSIInfo(),(h=this.info)!=null&&h.pv&&this.info.pv.length>=1&&this.info.pv[0].equals(a)){const S={...this.info,pv:this.info.pv.slice(1)};r.onMove(a,S)}else r.onMove(a)}onCheckmate(e,t){if(e!==this.usi||!this.position)return;const i=this.mateHandler;if(this.clearHandlers(),!i)return;const r=this.position,a=[];for(const c of t){const h=r.createMoveByUSI(c);if(!h){i.onError("エンジンから不明な指し手を受信しました:"+c);return}if(a.push(h),!r.doMove(h)){i.onError("エンジンから無効な指し手を受信しました:"+c);return}}i.onCheckmate(a)}onCheckmateNotImplemented(){const e=this.mateHandler;this.clearHandlers(),e==null||e.onNotImplemented()}onCheckmateTimeout(e){if(e!==this.usi||!this.position)return;const t=this.mateHandler;this.clearHandlers(),t==null||t.onTimeout()}onNoMate(e){if(e!==this.usi||!this.position)return;const t=this.mateHandler;this.clearHandlers(),t==null||t.onNoMate()}onUSIInfo(e,t){var a,c,h,S,I;if(e!==this.usi||!this.position||t.multipv&&t.multipv!==1)return;const i=this.position.color===f.BLACK?1:-1,r=t.pv&&t.pv.length>=1?t.pv:t.currmove?[t.currmove]:void 0;this.info={usi:e,depth:t.depth??((a=this.info)==null?void 0:a.depth),nodes:t.nodes??((c=this.info)==null?void 0:c.nodes),score:(t.scoreCP&&t.scoreCP*i)??((h=this.info)==null?void 0:h.score),mate:(t.scoreMate&&t.scoreMate*i)??((S=this.info)==null?void 0:S.mate),pv:(r&&Pt(this.position,r))??((I=this.info)==null?void 0:I.pv)},!this.inPonder&&(this.usiInfoTimeout||(this.usiInfoTimeout=window.setTimeout(()=>{this.flushUSIInfo()},500)))}flushUSIInfo(){var e;this.usiInfoTimeout&&(clearTimeout(this.usiInfoTimeout),this.usiInfoTimeout=void 0),this.info&&((e=this.onSearchInfo)==null||e.call(this,this.info))}}const N={};function Xt(s,e,t,i){var r;(r=N[s])==null||r.onBestMove(e,t,i)}function Zt(s,e,t){const i=N[s];i&&(fe(s,e,i.name,{pv:t}),i.onCheckmate(e,t))}function es(s){var e;(e=N[s])==null||e.onCheckmateNotImplemented()}function ts(s,e){var t;(t=N[s])==null||t.onCheckmateTimeout(e)}function ss(s,e){var t;(t=N[s])==null||t.onNoMate(e)}function is(s,e,t){const i=N[s];i&&(fe(s,e,i.name,t),i.onUSIInfo(e,t))}function rs(s,e,t){const i=N[s];i&&(Be(s,e,i.name,t),i.onUSIInfo(e,t))}function as(s){return!!N[s]}function Q(s){return{async build(e,t){if(e.uri===le)return ue;if(pt(e.uri)&&e.usi){const i=new Y(e.usi,s??10,t);return await i.launch(),i}throw new Error("defaultPlayerBuilder#build: 予期せぬプレイヤーURIです: "+e.uri)}}}var y=(s=>(s.WIN="win",s.LOSE="lose",s.DRAW="draw",s))(y||{});const se=1.96,os=2.58;function ns(s,e,t){return Math.abs(s-e*t)/Math.sqrt(t*(1-t)*e)}function B(s){return 400*Math.log10(s/(1-s))}function we(s,e,t){return s*Math.sqrt(e*(1-e)/t)}function cs(s){const e=s.player1.win+s.player2.win,t=e+s.draw,i=Math.max(s.player1.win,s.player2.win),r=i/e,a=we(se,r,e),c=(i+s.draw*.5)/t,h=we(se,c,t),S=B(r),I=B(r-a),_=B(r+a),v=B(c),x=B(c-h),$=B(c+h),L=Math.abs(ns(s.player1.win,e,.5));return{rating:S,ratingLower:I,ratingUpper:_,ratingWithDraw:v,ratingWithDrawLower:x,ratingWithDrawUpper:$,npIsGreaterThan5:e>10,zValue:L,significance5pc:L>se,significance1pc:L>os}}function Ce(s,e){return{player1:{name:s,win:0},player2:{name:e,win:0},draw:0,invalid:0,total:0}}class hs{constructor(e,t,i){o(this,"state");o(this,"_settings");o(this,"startPly",0);o(this,"repeat",0);o(this,"blackPlayer");o(this,"whitePlayer");o(this,"playerBuilder",Q());o(this,"_results",Ce("",""));o(this,"lastEventID");o(this,"onSaveRecord",()=>{});o(this,"onGameNext",()=>{});o(this,"onGameEnd",()=>{});o(this,"onFlipBoard",()=>{});o(this,"onPieceBeat",()=>{});o(this,"onBeepShort",()=>{});o(this,"onBeepUnlimited",()=>{});o(this,"onStopBeep",()=>{});o(this,"onError",()=>{});this.recordManager=e,this.blackClock=t,this.whiteClock=i,this.state="idle",this._settings=gt(),this.lastEventID=0}on(e,t){switch(e){case"saveRecord":this.onSaveRecord=t;break;case"gameNext":this.onGameNext=t;break;case"gameEnd":this.onGameEnd=t;break;case"flipBoard":this.onFlipBoard=t;break;case"pieceBeat":this.onPieceBeat=t;break;case"beepShort":this.onBeepShort=t;break;case"beepUnlimited":this.onBeepUnlimited=t;break;case"stopBeep":this.onStopBeep=t;break;case"error":this.onError=t;break}return this}get settings(){return this._settings}get results(){return this._results}async start(e,t){if(this.state!=="idle")throw Error("GameManager#start: 前回の対局が正常に終了できていません。アプリを再起動してください。");this.state="STARTING",this._settings=e,this.playerBuilder=t,this.repeat=0,e.startPosition||(this.startPly=this.recordManager.record.current.ply),this._results=Ce(e.black.name,e.white.name);try{this.blackPlayer=await this.playerBuilder.build(this.settings.black,i=>this.updateSearchInfo(M.OPPONENT,i)),this.whitePlayer=await this.playerBuilder.build(this.settings.white,i=>this.updateSearchInfo(M.OPPONENT,i)),await this.goNextGame()}catch(i){try{await this.closePlayers()}catch(r){this.onError(r)}finally{this.state="idle"}throw new Error(`GameManager#start: ${l.failedToStartNewGame}: ${i}`)}}async goNextGame(){if(this.blackPlayer===void 0||this.whitePlayer===void 0)throw new Error("GameManager#goNextGame: プレイヤーが初期化されていません。");this.repeat++,this.settings.startPosition?this.recordManager.resetByInitialPositionType(this.settings.startPosition):this.recordManager.record.current.ply!==this.startPly&&(this.recordManager.changePly(this.startPly),this.recordManager.removeNextMove()),this.recordManager.setGameStartMetadata({gameTitle:this.settings.repeat>=2?`連続対局 ${this.repeat}/${this.settings.repeat}`:void 0,blackName:this.settings.black.name,whiteName:this.settings.white.name,blackTimeLimit:this.settings.timeLimit,whiteTimeLimit:this.settings.whiteTimeLimit||this.settings.timeLimit}),this.blackClock.setup(this.getBlackClockSettings()),this.whiteClock.setup(this.getWhiteClockSettings()),await Promise.all([this.blackPlayer.readyNewGame(),this.whitePlayer.readyNewGame()]),this.state="active",this.onGameNext(),this.adjustBoardOrientation(),setTimeout(()=>this.nextMove())}getCommonClockSettings(){return{timeMs:this.settings.timeLimit.timeSeconds*1e3,byoyomi:this.settings.timeLimit.byoyomi,increment:this.settings.timeLimit.increment,onBeepShort:()=>this.onBeepShort(),onBeepUnlimited:()=>this.onBeepUnlimited(),onStopBeep:()=>this.onStopBeep()}}getBlackClockSettings(){return{...this.getCommonClockSettings(),onTimeout:()=>{this.timeout(f.BLACK)}}}getWhiteClockSettings(){const e={...this.getCommonClockSettings(),onTimeout:()=>{this.timeout(f.WHITE)}};return this.settings.whiteTimeLimit?{...e,timeMs:this.settings.whiteTimeLimit.timeSeconds*1e3,byoyomi:this.settings.whiteTimeLimit.byoyomi,increment:this.settings.whiteTimeLimit.increment}:e}adjustBoardOrientation(){var e,t,i,r;this.settings.humanIsFront&&(!((e=this.blackPlayer)!=null&&e.isEngine())&&((t=this.whitePlayer)!=null&&t.isEngine())?this.onFlipBoard(!1):(i=this.blackPlayer)!=null&&i.isEngine()&&!((r=this.whitePlayer)!=null&&r.isEngine())&&this.onFlipBoard(!0))}nextMove(){var c;if(this.state!=="active")return;if(this._settings.maxMoves&&this.recordManager.record.current.ply>=this._settings.maxMoves&&!this.recordManager.record.current.isCheck&&!((c=this.recordManager.record.current.prev)!=null&&c.isCheck)){this.end(u.IMPASS);return}this.getActiveClock().start();const e=this.recordManager.record.position.color,t=this.getPlayer(e),i=this.getPlayer(pe(e));if(!t||!i){this.onError(new Error("GameManager#nextMove: プレイヤーが初期化されていません。"));return}const r=this.issueEventID(),a={black:{timeMs:this.blackClock.timeMs,byoyomi:this.blackClock.settings.byoyomi||0,increment:this.blackClock.settings.increment||0},white:{timeMs:this.whiteClock.timeMs,byoyomi:this.whiteClock.settings.byoyomi||0,increment:this.whiteClock.settings.increment||0}};t.startSearch(this.recordManager.record.position,this.recordManager.record.usi,a,{onMove:(h,S)=>this.onMove(r,h,S),onResign:()=>this.onResign(r),onWin:()=>this.onWin(r),onError:h=>this.onError(h)}).catch(h=>{this.onError(new Error(`GameManager#nextMove: ${l.failedToSendGoCommand}: ${h}`))}),i.startPonder(this.recordManager.record.position,this.recordManager.record.usi,a).catch(h=>{this.onError(new Error(`GameManager#nextMove: ${l.failedToSendPonderCommand}: ${h}`))})}onMove(e,t,i){if(e!==this.lastEventID){m.log(b.ERROR,"GameManager#onMove: event ID already disabled");return}if(this.state!=="active"){m.log(b.ERROR,"GameManager#onMove: invalid state: "+this.state);return}if(!this.recordManager.record.position.isValidMove(t)){this.onError("反則手: "+z(this.recordManager.record.position,t)),this.end(u.FOUL_LOSE);return}this.getActiveClock().stop(),this.recordManager.appendMove({move:t,moveOption:{ignoreValidation:!0},elapsedMs:this.getActiveClock().elapsedMs}),i&&this.updateSearchInfo(M.PLAYER,i),i&&this.settings.enableComment&&this.recordManager.appendSearchComment(M.PLAYER,i,H.APPEND),this.onPieceBeat();const r=this.recordManager.record.perpetualCheck;if(r)if(r===this.recordManager.record.position.color){this.end(u.FOUL_LOSE);return}else{this.end(u.FOUL_WIN);return}else if(this.recordManager.record.repetition){this.end(u.REPETITION_DRAW);return}if(this.settings.jishogiRule==K.TRY&&t.pieceType===he.KING&&(t.color===f.BLACK&&t.to.equals(new j(5,1))||t.color===f.WHITE&&t.to.equals(new j(5,9)))){this.end(u.TRY);return}this.nextMove()}onResign(e){if(e!==this.lastEventID){m.log(b.ERROR,"GameManager#onResign: event ID already disabled");return}if(this.state!=="active"){m.log(b.ERROR,"GameManager#onResign: invalid state: "+this.state);return}this.end(u.RESIGN)}onWin(e){if(e!==this.lastEventID){m.log(b.ERROR,"GameManager#onWin: event ID already disabled");return}if(this.state!=="active"){m.log(b.ERROR,"GameManager#onWin: invalid state: "+this.state);return}const t=this.recordManager.record.position;if(this.settings.jishogiRule==K.NONE||this.settings.jishogiRule==K.TRY){this.end(u.FOUL_LOSE);return}const i=this.settings.jishogiRule==K.GENERAL24?F.GENERAL24:F.GENERAL27;switch(W(i,t,t.color)){case Z.WIN:this.end(u.ENTERING_OF_KING);break;case Z.DRAW:this.end(u.DRAW);break;case Z.LOSE:this.end(u.FOUL_LOSE);break}}timeout(e){this.onStopBeep();const t=this.getPlayer(e);if(t!=null&&t.isEngine()&&!this.settings.enableEngineTimeout){t.stop().catch(i=>{this.onError(new Error(`GameManager#timeout: ${l.failedToSendStopCommand}: ${i}`))});return}this.end(u.TIMEOUT)}stop(){this.end(u.INTERRUPT)}end(e){if(this.state!=="active"&&this.state!=="pending")return;this.state="busy";const t=this.recordManager.record.position.color;Promise.resolve().then(()=>this.sendGameResult(t,e)).then(()=>{if(this.getActiveClock().pause(),this.recordManager.appendMove({move:e,elapsedMs:this.getActiveClock().elapsedMs}),this.recordManager.setGameEndMetadata(),this.addGameResults(t,e),this._settings.enableAutoSave&&this.onSaveRecord(),e===u.INTERRUPT||this.repeat>=this.settings.repeat){this.closePlayers().catch(r=>{this.onError(r)}).finally(()=>{this.state="idle",this.onGameEnd(this.results,e)});return}this.settings.swapPlayers&&this.swapPlayers(),this.state="STARTING",this.goNextGame().catch(r=>{this.onError(new Error(`GameManager#end: ${l.failedToStartNewGame}: ${r}`))})}).catch(i=>{this.onError(new Error(`GameManager#end: ${l.errorOccuredWhileEndingGame}: ${i}`)),this.state="pending"})}updateSearchInfo(e,t){this.state==="active"&&this.recordManager.updateSearchInfo(e,t)}addGameResults(e,t){switch(ie(e,f.BLACK,t)){case y.WIN:this._results.player1.win++;break;case y.LOSE:this._results.player2.win++;break;case y.DRAW:this._results.draw++;break;default:this._results.invalid++;break}this._results.total++}swapPlayers(){this._settings={...this.settings,black:this.settings.white,white:this.settings.black},this._settings.whiteTimeLimit&&(this._settings={...this.settings,timeLimit:this._settings.whiteTimeLimit,whiteTimeLimit:this._settings.timeLimit}),[this.blackPlayer,this.whitePlayer]=[this.whitePlayer,this.blackPlayer],this._results={...this.results,player1:this.results.player2,player2:this.results.player1}}async sendGameResult(e,t){if(this.blackPlayer){const i=ie(e,f.BLACK,t);i&&await this.blackPlayer.gameover(i)}if(this.whitePlayer){const i=ie(e,f.WHITE,t);i&&await this.whitePlayer.gameover(i)}}async closePlayers(){const e=[];this.blackPlayer&&(e.push(this.blackPlayer.close()),this.blackPlayer=void 0),this.whitePlayer&&(e.push(this.whitePlayer.close()),this.whitePlayer=void 0);try{await Promise.all(e)}catch(t){throw new Error(`GameManager#closePlayers: ${l.failedToShutdownEngines}: ${t}`)}}getPlayer(e){switch(e){case f.BLACK:return this.blackPlayer;case f.WHITE:return this.whitePlayer}}getActiveClock(){switch(this.recordManager.record.position.color){case f.BLACK:return this.blackClock;case f.WHITE:return this.whiteClock}}issueEventID(){return this.lastEventID+=1,this.lastEventID}}function ie(s,e,t){switch(t){case u.FOUL_WIN:case u.ENTERING_OF_KING:return s==e?y.WIN:y.LOSE;case u.RESIGN:case u.MATE:case u.TIMEOUT:case u.FOUL_LOSE:case u.TRY:return s==e?y.LOSE:y.WIN;case u.IMPASS:case u.REPETITION_DRAW:return y.DRAW}return null}function ls(s,e,t){const i=s.clone();let r,a="",c=0;for(;c<e.length&&c<t;c++){const h=i.createMoveByUSI(e[c]);if(!h)break;a+=z(i,h,{lastMove:r}),i.doMove(h,{ignoreValidation:!0}),r=h}for(;c<e.length&&c<t;c++)a+=" "+e[c];return c<e.length&&(a+=" ..."),a}let ds=0;class us{constructor(e,t){o(this,"sfen","");o(this,"nodes");o(this,"nps");o(this,"iterations",[]);o(this,"hashfull");o(this,"currentMove");o(this,"currentMoveText");o(this,"ponderMove");this.sessionID=e,this.name=t}get latestIteration(){const e=[],t=new Set,i=new Set;for(const r of this.iterations){const a=r.pv?r.pv[0]:void 0;!t.has(r.multiPV)&&!i.has(a)&&(e.push(r),t.add(r.multiPV),i.add(a))}return e.sort((r,a)=>(r.multiPV||1)-(a.multiPV||1))}update(e,t,i,r){this.sfen!==e&&(this.sfen=e,this.nodes=void 0,this.nps=void 0,this.iterations=[],this.hashfull=void 0,this.currentMove=void 0,this.currentMoveText=void 0,this.ponderMove=void 0);const a=J.newBySFEN(e);if(!a)return;const c={id:ds++,position:e,color:a.color};if(t.depth!==void 0&&(c.depth=t.depth),t.seldepth!==void 0&&(c.selectiveDepth=t.seldepth),t.timeMs!==void 0&&(c.timeMs=t.timeMs),t.nodes!==void 0&&(this.nodes=t.nodes),t.pv&&(c.pv=t.pv,c.text=ls(a,t.pv,i)),t.multipv!==void 0&&(c.multiPV=t.multipv),t.scoreCP!==void 0&&(c.score=t.scoreCP),t.scoreMate!==void 0&&(c.scoreMate=t.scoreMate),t.lowerbound!==void 0&&(c.lowerBound=t.lowerbound),t.upperbound!==void 0&&(c.upperBound=t.upperbound),t.currmove!==void 0){this.currentMove=t.currmove;const h=a.createMoveByUSI(t.currmove);h&&(this.currentMoveText=z(a,h))}t.hashfullPerMill!==void 0&&(this.hashfull=t.hashfullPerMill/1e3),t.nps!==void 0&&(this.nps=t.nps),t.string&&(c.text=t.string),Object.keys(c).length!==0&&(t.nodes!==void 0&&(c.nodes=t.nodes),this.iterations.unshift(c)),this.ponderMove=r&&z(a,r)}}class ms{constructor(){o(this,"_sessions",[]);o(this,"updateQueue",[]);o(this,"timeoutHandle")}get sessions(){return this._sessions}update(e,t,i,r,a,c){this.updateQueue.push({sessionID:e,sfen:t.sfen,name:i,info:r,maxPVLength:a,ponderMove:c}),this.timeoutHandle||(this.timeoutHandle=window.setTimeout(()=>{this.dequeue()},500))}dequeue(){this._sessions=this._sessions.filter(e=>as(e.sessionID)||this.updateQueue.some(t=>t.sessionID===e.sessionID));for(const e of this.updateQueue)this._update(e);this.updateQueue=[],this.timeoutHandle=void 0}_update(e){let t=this._sessions.find(i=>i.sessionID===e.sessionID);t||(t=this.addSession(e.sessionID,e.name)),t.update(e.sfen,e.info,e.maxPVLength,e.ponderMove)}addSession(e,t){const i=new us(e,t);return this.sessions.push(i),this.sessions.sort((r,a)=>r.sessionID-a.sessionID),i}}var n=(s=>(s.NORMAL="normal",s.PASTE_DIALOG="pasteDialog",s.POSITION_EDITING="positionEditing",s.PIECE_SET_CHANGE_DIALOG="pieceSetChangeDialog",s.EXPORT_POSITION_IMAGE_DIALOG="exportBoardImageDialog",s.GAME_DIALOG="gameDialog",s.GAME="game",s.CSA_GAME_DIALOG="csaGameDialog",s.CSA_GAME="csaGame",s.ANALYSIS="analysis",s.ANALYSIS_DIALOG="analysisDialog",s.MATE_SEARCH="mateSearch",s.MATE_SEARCH_DIALOG="mateSearchDialog",s.USI_ENGINES_DIALOG="usiEnginesDialog",s.RECORD_FILE_HISTORY_DIALOG="recordFileHistoryDialog",s.BATCH_CONVERSION_DIALOG="batchConversionDialog",s.LAUNCH_USI_ENGINE_DIALOG="launchUsiEngineDialog",s.CONNECT_TO_CSA_SERVER_DIALOG="connectToCsaServerDialog",s.LOAD_REMOTE_FILE_DIALOG="loadRemoteFileDialog",s.SHARE_DIALOG="shareDialog",s))(n||{}),A=(s=>(s.IDLE="idle",s.STARTUP_DIALOG="startupDialog",s.RUNNING="running",s))(A||{});class ps{constructor(e){o(this,"researcher");o(this,"settings",St());o(this,"ply");o(this,"actualMove");o(this,"lastSearchInfo");o(this,"searchInfo");o(this,"timerHandle");o(this,"onFinish",()=>{});o(this,"onError",()=>{});this.recordManager=e}on(e,t){switch(e){case"finish":this.onFinish=t;break;case"error":this.onError=t;break}return this}async start(e){if(!e.usi)throw new Error("エンジンが設定されていません。");await this.setupEngine(e.usi),this.settings=e,this.ply=void 0,this.actualMove=void 0,this.lastSearchInfo=void 0,this.searchInfo=void 0,setTimeout(()=>this.next())}close(){this.clearTimer(),this.closeEngine().catch(e=>{this.onError(e)})}async setupEngine(e){if(this.researcher)throw new Error("AnalysisManager#setupEngine: 前回のエンジンが終了していません。数秒待ってからもう一度試してください。");const t=p(),i=new Y(e,t.engineTimeoutSeconds,this.updateSearchInfo.bind(this));await i.launch(),await i.readyNewGame(),this.researcher=i}async closeEngine(){this.researcher&&(await this.researcher.close(),this.researcher=void 0)}next(){if(this.clearTimer(),!this.researcher){this.onError(new Error("エンジンが初期化されていません。")),this.finish();return}if(this.lastSearchInfo=this.searchInfo,this.searchInfo=void 0,this.ply!==void 0?this.ply=this.ply+1:this.settings.startCriteria.enableNumber?this.ply=this.settings.startCriteria.number-1:this.ply=0,this.settings.endCriteria.enableNumber&&this.ply>=this.settings.endCriteria.number){this.finish();return}this.recordManager.changePly(this.ply);const e=this.recordManager.record;if(e.current.ply!==this.ply){this.finish();return}if(!e.current.next&&!(e.current.move instanceof de)){this.finish();return}this.actualMove=e.current.move instanceof de?e.current.move:void 0,this.setTimer(),this.researcher.startResearch(this.recordManager.record.position,this.recordManager.record.usi).catch(t=>{this.onError(t)})}finish(){this.onFinish(),this.close()}setTimer(){this.timerHandle=window.setTimeout(()=>{this.onResult(),this.next()},this.settings.perMoveCriteria.maxSeconds*1e3)}clearTimer(){this.timerHandle&&(clearTimeout(this.timerHandle),this.timerHandle=void 0)}onResult(){var I;if(!this.searchInfo||!this.lastSearchInfo)return;const e=this.recordManager.record,i=pe(e.position.color)===f.BLACK?1:-1,r=this.searchInfo.score!==void 0?this.searchInfo.score*i:void 0,a=this.searchInfo.score!==void 0&&this.lastSearchInfo.score!==void 0?(this.searchInfo.score-this.lastSearchInfo.score)*i:void 0,c=this.actualMove&&this.lastSearchInfo.pv?this.actualMove.equals(this.lastSearchInfo.pv[0]):void 0,h=p();let S="";if(a!==void 0&&r!==void 0&&!c){const _=gs(r-a,r,h);_&&(S=`【${_}】`)}this.recordManager.appendSearchComment(M.RESEARCHER,this.searchInfo,this.settings.commentBehavior,{header:S,engineName:(I=this.settings.usi)==null?void 0:I.name})}updateSearchInfo(e){this.recordManager.updateSearchInfo(M.RESEARCHER,e),this.searchInfo=e}}function gs(s,e,t){const i=Ne(s,t.coefficientInSigmoid)-Ne(e,t.coefficientInSigmoid);return i>=t.badMoveLevelThreshold4?l.blunder:i>=t.badMoveLevelThreshold3?l.mistake:i>=t.badMoveLevelThreshold2?l.dubious:i>=t.badMoveLevelThreshold1?l.inaccuracy:null}function Oe(){return{timeUnitMs:1e3,totalTime:0,byoyomi:0,delay:0,increment:0}}function Ss(){return{id:"",myColor:f.BLACK,toMove:f.BLACK,position:"",players:{black:{time:Oe()},white:{time:Oe()}}}}var C=(s=>(s.UNKNOWN="unknown",s.RESIGN="resign",s.SENNICHITE="sennichite",s.OUTE_SENNICHITE="oute_sennichite",s.ILLEGAL_MOVE="illegal_move",s.ILLEGAL_ACTION="illegal_action",s.TIME_UP="time_up",s.JISHOGI="jishogi",s.MAX_MOVES="max_moves",s))(C||{}),O=(s=>(s.WIN="win",s.LOSE="lose",s.DRAW="draw",s.CENSORED="censored",s.CHUDAN="chudan",s))(O||{});const fs=10;var He=(s=>(s[s.OFFLINE=0]="OFFLINE",s[s.PLAYER_SETUP=1]="PLAYER_SETUP",s[s.WAITING_LOGIN=2]="WAITING_LOGIN",s[s.LOGIN_FAILED=3]="LOGIN_FAILED",s[s.LOGIN_RETRY_INTERVAL=4]="LOGIN_RETRY_INTERVAL",s[s.READY=5]="READY",s[s.GAME=6]="GAME",s))(He||{});class Es{constructor(e,t,i){o(this,"_state",0);o(this,"_settings",ft());o(this,"_sessionID",0);o(this,"stopRequested",!1);o(this,"repeat",0);o(this,"player");o(this,"gameSummary",Ss());o(this,"searchInfo");o(this,"playerBuilder",Q());o(this,"retryTimer");o(this,"onSaveRecord",()=>{});o(this,"onGameNext",()=>{});o(this,"onNewGame",()=>{});o(this,"onGameEnd",()=>{});o(this,"onLoginRetry",()=>{});o(this,"onFlipBoard",()=>{});o(this,"onPieceBeat",()=>{});o(this,"onBeepShort",()=>{});o(this,"onBeepUnlimited",()=>{});o(this,"onStopBeep",()=>{});o(this,"onError",()=>{});this.recordManager=e,this.blackClock=t,this.whiteClock=i}on(e,t){switch(e){case"saveRecord":this.onSaveRecord=t;break;case"gameNext":this.onGameNext=t;break;case"newGame":this.onNewGame=t;break;case"gameEnd":this.onGameEnd=t;break;case"loginRetry":this.onLoginRetry=t;break;case"flipBoard":this.onFlipBoard=t;break;case"pieceBeat":this.onPieceBeat=t;break;case"beepShort":this.onBeepShort=t;break;case"beepUnlimited":this.onBeepUnlimited=t;break;case"stopBeep":this.onStopBeep=t;break;case"error":this.onError=t;break}return this}get state(){return this._state}get settings(){return this._settings}get sessionID(){return this._sessionID}get usiSessionID(){return this.player instanceof Y?this.player.sessionID:0}get isMyTurn(){return this.recordManager.record.position.color===this.gameSummary.myColor}async login(e,t){if(this.sessionID)throw new Error("CSAGameManager#login: session already exists");if(this._state!==0)throw new Error("CSAGameManager#login: unexpected state");this._state=1,this._settings=e,this.playerBuilder=t,this.repeat=0,this.player=await this.playerBuilder.build(this._settings.player,i=>this.recordManager.updateSearchInfo(M.OPPONENT,i)),this._login().catch(this.onError)}async relogin(){this.settings.restartPlayerEveryGame&&(this._state=1,this.player&&(await this.player.close(),this.player=void 0),this.player=await this.playerBuilder.build(this._settings.player,e=>this.recordManager.updateSearchInfo(M.OPPONENT,e))),await this._login()}async _login(){if(!this.player)throw new Error("CSAGameManager#relogin: player is not initialized");try{this._state=1,await this.player.readyNewGame(),this._state=2;const e=await m.csaLogin(this._settings.server);this._sessionID=e,this._state=5,Rs(this.sessionID,this),this.onGameNext()}catch(e){throw this._state=3,this.close(1),new Error(`CSAGameManager#relogin: ${l.failedToStartNewGame}: ${e}`)}}stop(){this.sessionID&&(this.stopRequested=!0,m.csaStop(this.sessionID))}logout(){this.close(0)}close(e){if(!(this._state===0||this._state===2)){if(this._state===6&&this.settings.enableAutoSave&&this.onSaveRecord(),this.stopRequested&&(e=0,this.stopRequested=!1),this.sessionID&&(Is(this.sessionID),m.csaLogout(this.sessionID).catch(t=>{this.onError(new Error(`CSAGameManager#close: ${l.errorOccuredWhileLogoutFromCSAServer}: ${t}`))}),this._sessionID=0),this.blackClock.stop(),this.whiteClock.stop(),this._state=0,this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=void 0),e===0||this.repeat>=this.settings.repeat){this.player&&(this.player.close().catch(t=>{this.onError(new Error(`CSAGameManager#close: ${l.failedToShutdownEngines}: ${t}`))}),this.player=void 0),this.onGameEnd();return}e===2?this.relogin().catch(this.onError):(this._state=4,this.onLoginRetry(),this.retryTimer=setTimeout(()=>this.relogin().catch(this.onError),fs*1e3))}}onGameSummary(e){this.gameSummary=e;const t=this.recordManager.importRecord(this.gameSummary.position,{type:P.CSA});if(t){this.onError(`CSAGameManager#onGameSummary: ${t}`),this.close(0);return}this.recordManager.changePly(Number.MAX_SAFE_INTEGER),m.csaAgree(this.sessionID,this.gameSummary.id)}onReject(){this.close(1)}onStart(e){this.repeat++,this.onNewGame(this.repeat);const t=this.gameSummary.players.black.time,i=this.gameSummary.players.white.time;this.recordManager.setGameStartMetadata({gameTitle:this.gameSummary.id,blackName:this.gameSummary.players.black.playerName,whiteName:this.gameSummary.players.white.playerName,blackTimeLimit:{timeSeconds:t.totalTime*t.timeUnitMs/1e3,byoyomi:t.byoyomi*t.timeUnitMs/1e3,increment:t.increment*t.timeUnitMs/1e3},whiteTimeLimit:{timeSeconds:i.totalTime*i.timeUnitMs/1e3,byoyomi:i.byoyomi*i.timeUnitMs/1e3,increment:i.increment*i.timeUnitMs/1e3}}),this.settings.autoFlip&&this.onFlipBoard&&this.onFlipBoard(this.gameSummary.myColor===f.WHITE),this._state=6,this.next(e)}onMove(e,t){const i=this.isMyTurn,r=Le(this.recordManager.record.position,e);if(r instanceof Error){this.onError(`CSAGameManager#onMove: 解釈できない指し手 [${e}]: ${r.message}`);return}this.recordManager.appendMove({move:r,moveOption:{ignoreValidation:!0},elapsedMs:this.parseElapsedMs(r.color,e)}),i&&this.searchInfo&&this.recordManager.updateSearchInfo(M.PLAYER,this.searchInfo),i&&this.searchInfo&&this.settings.enableComment&&this.recordManager.appendSearchComment(M.PLAYER,this.searchInfo,H.APPEND),this.onPieceBeat(),this.next(t)}parseElapsedMs(e,t){const i=this.gameSummary.players[e].time,r=/^.*,T([0-9]+)$/.exec(t);return r?Number(parseInt(r[1]))*i.timeUnitMs:0}onGameResult(e,t){if(this.recordManager.appendMove({move:this.gameResultToSpecialMove(e,t)}),this.player){let i;switch(t){case O.WIN:i=y.WIN;break;case O.LOSE:i=y.LOSE;break;case O.DRAW:case O.CENSORED:case O.CHUDAN:i=y.DRAW;break}this.player.gameover(i)}this.close(2)}gameResultToSpecialMove(e,t){const i=this.recordManager.record.position.color;switch(e){case C.RESIGN:return u.RESIGN;case C.SENNICHITE:return u.REPETITION_DRAW;case C.OUTE_SENNICHITE:case C.ILLEGAL_MOVE:case C.ILLEGAL_ACTION:switch(t){case O.WIN:return i===this.gameSummary.myColor?u.FOUL_WIN:u.FOUL_LOSE;case O.LOSE:return i===this.gameSummary.myColor?u.FOUL_LOSE:u.FOUL_WIN}break;case C.TIME_UP:return u.TIMEOUT;case C.JISHOGI:return u.ENTERING_OF_KING;case C.MAX_MOVES:return u.IMPASS}return t===O.DRAW?u.DRAW:u.INTERRUPT}onClose(){this.close(this.settings.autoRelogin?1:0)}next(e){this.blackClock.stop(),this.whiteClock.stop(),this.syncClock(e),this.startClock(),this.recordManager.record.position.color===this.gameSummary.myColor?this.startSearch(e):this.startPonder()}syncClock(e){const t={onBeepShort:()=>this.onBeepShort(),onBeepUnlimited:()=>this.onBeepUnlimited(),onStopBeep:()=>this.onStopBeep()},i=this.gameSummary.players.black.time;this.blackClock.setup({...t,timeMs:e.black.time*i.timeUnitMs,byoyomi:i.byoyomi*i.timeUnitMs/1e3});const r=this.gameSummary.players.white.time;this.whiteClock.setup({...t,timeMs:e.white.time*r.timeUnitMs,byoyomi:r.byoyomi*r.timeUnitMs/1e3})}startClock(){this.recordManager.record.position.color===f.BLACK?this.blackClock.start():this.whiteClock.start()}startSearch(e){if(!this.player){this.onError("CSAGameManager#startSearch: player is not initialized");return}this.player.startSearch(this.recordManager.record.position,this.recordManager.record.usi,this.buildTimeStates(e),{onMove:this.onPlayerMove.bind(this),onResign:this.onPlayerResign.bind(this),onWin:this.onPlayerWin.bind(this),onError:this.onPlayerError.bind(this)}).catch(t=>{this.onError(new Error(`CSAGameManager#startSearch: ${l.failedToSendGoCommand}: ${t}`))})}startPonder(){if(!this.player){this.onError("CSAGameManager#startPonder: player is not initialized");return}this.player.startPonder(this.recordManager.record.position,this.recordManager.record.usi,this.buildTimeStates()).catch(e=>{this.onError(new Error(`CSAGameManager#startPonder: ${l.failedToSendPonderCommand}: ${e}`))})}startEarlyPonder(e){if(!this.player){this.onError("CSAGameManager#startEarlyPonder: player is not initialized");return}const t=this.recordManager.record.position.clone(),i=this.recordManager.record.usi+" "+e.usi;if(!t.doMove(e)){this.onError("CSAGameManager#startEarlyPonder: failed to make a move");return}this.player.startPonder(t,i,this.buildTimeStates()).catch(r=>{this.onError(new Error(`CSAGameManager#startEarlyPonder: ${l.failedToSendPonderCommand}: ${r}`))})}buildTimeStates(e){const t=this.gameSummary.players.black.time,i=this.gameSummary.players.white.time;return{black:{timeMs:e?e.black.time*t.timeUnitMs:this.blackClock.timeMs,byoyomi:t.byoyomi*t.timeUnitMs/1e3,increment:t.increment*t.timeUnitMs/1e3},white:{timeMs:e?e.white.time*i.timeUnitMs:this.whiteClock.timeMs,byoyomi:i.byoyomi*i.timeUnitMs/1e3,increment:i.increment*i.timeUnitMs/1e3}}}onPlayerMove(e,t){var a,c;this.searchInfo=t;let i,r;switch(this._settings.server.protocolVersion){case Re.V121:break;case Re.V121_FLOODGATE:i=t==null?void 0:t.score,(a=t==null?void 0:t.pv)==null||a.forEach(h=>{r=r?r+" ":"",r+=Ie(h)});break}m.csaMove(this.sessionID,Ie(e),i,r),(c=this.settings.player.usi)!=null&&c.enableEarlyPonder&&this.startEarlyPonder(e)}onPlayerResign(){m.csaResign(this.sessionID)}onPlayerWin(){m.csaWin(this.sessionID)}onPlayerError(e){this.onError(e)}}const D={};function Rs(s,e){D[s]=e}function Is(s){delete D[s]}function _s(s,e){var t;(t=D[s])==null||t.onGameSummary(e)}function Ms(s){var e;(e=D[s])==null||e.onReject()}function ys(s,e){var t;(t=D[s])==null||t.onStart(e)}function Ts(s,e,t){var i;(i=D[s])==null||i.onMove(e,t)}function bs(s,e,t){var i;(i=D[s])==null||i.onGameResult(e,t)}function As(s){var e;(e=D[s])==null||e.onClose()}class Pe{constructor(){o(this,"_settings",{timeMs:0,byoyomi:0,increment:0});o(this,"_timeMs",0);o(this,"_byoyomi",0);o(this,"_elapsedMs",0);o(this,"timerHandle",0);o(this,"timerStart",0);o(this,"lastTimeMs",0)}setup(e){this._settings=e,this._timeMs=e.timeMs||0,this._byoyomi=e.byoyomi||0,this._elapsedMs=0}get settings(){return this._settings}get time(){return Math.ceil(this._timeMs/1e3)}get timeMs(){return this._timeMs}get byoyomi(){return this._byoyomi}get elapsedMs(){return this._elapsedMs}start(){this.clearTimer(),this.timerStart=Date.now(),this.lastTimeMs=this._timeMs,this._byoyomi=this.settings.byoyomi||0,this._elapsedMs=0,this.timerHandle=window.setInterval(()=>{const e=this.timeMs,t=this.byoyomi;this._elapsedMs=Date.now()-this.timerStart;const i=this.lastTimeMs-this._elapsedMs;if(i>=0?this._timeMs=i:(this._timeMs=0,this._byoyomi=Math.max(Math.ceil((this.settings.byoyomi||0)+i/1e3),0)),this.timeMs===0&&this.byoyomi===0){this.timeout();return}this.fireBeep(e,t)},100)}fireBeep(e,t){let i=Math.ceil(this.timeMs/1e3),r=Math.ceil(e/1e3);if(!(i!==0&&this.byoyomi!==0)){if(i===0&&r!==0){this.settings.onBeepShort&&this.settings.onBeepShort();return}this.byoyomi!==0&&(i=this.byoyomi,r=t),i!==r&&(i<=5?this.settings.onBeepUnlimited&&this.settings.onBeepUnlimited():(i<=10||i===20||i===30||i===60)&&this.settings.onBeepShort&&this.settings.onBeepShort())}}pause(){this.clearTimer()}stop(){this.clearTimer(),this.incrementTime()}timeout(){var e,t;this.clearTimer(),(t=(e=this.settings).onTimeout)==null||t.call(e)}clearTimer(){var e,t;this.timerHandle&&(window.clearInterval(this.timerHandle),this.timerHandle=0),(t=(e=this.settings).onStopBeep)==null||t.call(e)}incrementTime(){this._timeMs+=(this.settings.increment||0)*1e3}}class Ns{constructor(){o(this,"func");o(this,"timeout")}after(e,t){this.func=e,!this.timeout&&(this.timeout=setTimeout(this.invoke.bind(this),t))}invoke(){var e;(e=this.func)==null||e.call(this),this.clear()}clear(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0),this.func=void 0}}function vs(s){switch(s){case 0:return M.RESEARCHER;case 1:return M.RESEARCHER_2;case 2:return M.RESEARCHER_3;case 3:return M.RESEARCHER_4;default:return}}class ws{constructor(){o(this,"settings",Et());o(this,"engines",[]);o(this,"ready",!1);o(this,"onUpdateSearchInfo",()=>{});o(this,"onError",()=>{});o(this,"pausedEngineMap",{});o(this,"record");o(this,"lazyPositionUpdate",new Ns);o(this,"synced",!0)}on(e,t){switch(e){case"updateSearchInfo":this.onUpdateSearchInfo=t;break;case"error":this.onError=t;break}return this}async launch(e){var r;if(this.settings=e,e.usi===void 0)throw new Error("ResearchManager#launch: USIエンジンの設定は必須です。");for(const a of e.secondaries||[])if(a.usi===void 0)throw new Error("ResearchManager#launch: USIエンジンの設定は必須です。");if(this.engines.length>0)throw new Error("ResearchManager#launch: 前回のエンジンが終了していません。数秒待ってからもう一度試してください。");const t=p(),i=[e.usi,...((r=e.secondaries)==null?void 0:r.map(a=>a.usi))||[]];this.engines=i.map((a,c)=>{const h=vs(c);return{usi:new Y(a,t.engineTimeoutSeconds,S=>{h!==void 0&&this.synced&&this.onUpdateSearchInfo(h,S)})}});try{await Promise.all(this.engines.map(a=>a.usi.launch())),await Promise.all(this.engines.map(a=>a.usi.readyNewGame())),this.ready=!0}catch(a){throw this.close(),a}}updatePosition(e){this.synced=!1,this.lazyPositionUpdate.after(()=>{this.ready&&(this.engines.forEach(t=>{this.pausedEngineMap[t.usi.sessionID]||(t.usi.startResearch(e.position,e.usi).catch(i=>{this.onError(i)}),this.setupTimer(t))}),this.synced=!0,this.record=e)},200)}isPaused(e){return this.pausedEngineMap[e]||!1}pause(e){const t=this.engines.find(i=>i.usi.sessionID===e);t&&(this.pausedEngineMap[e]=!0,t.usi.stop().catch(i=>{this.onError(i)}))}unpause(e){const t=this.engines.find(i=>i.usi.sessionID===e);t&&(this.pausedEngineMap[e]=!1,this.record&&(t.usi.startResearch(this.record.position,this.record.usi).catch(i=>{this.onError(i)}),this.setupTimer(t)))}isSessionExists(e){return this.engines.some(t=>t.usi.sessionID===e)}setupTimer(e){clearTimeout(e.timer),this.settings.enableMaxSeconds&&this.settings.maxSeconds>0&&(e.timer=setTimeout(()=>{e.usi.stop().catch(t=>{this.onError(t)})},this.settings.maxSeconds*1e3))}close(){this.lazyPositionUpdate.clear(),this.engines.forEach(e=>clearTimeout(e.timer)),Promise.allSettled(this.engines.map(e=>e.usi.close())).then(()=>{this.engines=[],this.pausedEngineMap={},this.ready=!1}).catch(e=>{this.onError(e)})}}class Cs{constructor(){o(this,"engine",null);o(this,"onNotImplemented",()=>{});o(this,"onCheckmate",()=>{});o(this,"onTimeout",()=>{});o(this,"onNoMate",()=>{});o(this,"onError",()=>{})}on(e,t){switch(e){case"checkmate":this.onCheckmate=t;break;case"notImplemented":this.onNotImplemented=t;break;case"timeout":this.onTimeout=t;break;case"noMate":this.onNoMate=t;break;case"error":this.onError=t;break}return this}async start(e,t){if(e.usi===void 0)throw new Error("MateSearchManager#start: USIエンジンの設定は必須です。");const i=p();this.engine=new Y(e.usi,i.engineTimeoutSeconds);try{await this.engine.launch(),await this.engine.readyNewGame(),await this.engine.startMateSearch(t.position,t.usi,{onCheckmate:r=>{this.close(),this.onCheckmate(r)},onNotImplemented:()=>{this.close(),this.onNotImplemented()},onTimeout:()=>{this.close(),this.onTimeout()},onNoMate:()=>{this.close(),this.onNoMate()},onError:r=>{this.close(),this.onError(r)}})}catch(r){throw this.close(),r}}close(){var e;(e=this.engine)==null||e.close().then(()=>{this.engine=null}).catch(t=>{this.onError(t)})}}function Os(s,e){const t={branch:!1,comment:!1,bookmark:!1,time:!1};if(e===G.KIF||e===G.KIFU)return t;switch(s.forEach(i=>{i.branch&&(t.branch=!0),i.comment&&(t.comment=!0),i.bookmark&&(t.bookmark=!0),i.elapsedMs&&(t.time=!0)}),e){case G.KI2:case G.KI2U:t.branch=!1,t.comment=!1,t.bookmark=!1;break;case G.CSA:t.comment=!1,t.time=!1;break;case G.SFEN:break;case G.JKF:t.branch=!1,t.comment=!1,t.time=!1;break}return t}class Ps{constructor(){o(this,"count",0)}get isBusy(){return this.count!==0}retain(){this.count+=1}release(){this.count-=1}}function ks(){return ge(new Ps)}let re;function g(){return re||(re=ks()),re}const Fe="mobile:record",xe="mobile:ply";function Ds(){if(Rt())return;const s=new URL(window.location.toString()).searchParams,e=s.get("usen");if(e){const a=parseInt(s.get("branch")||"0",10),c=parseInt(s.get("ply")||"0",10),h=U.newByUSEN(e,a,c);if(h instanceof Error){R().add(`棋譜の読み込み中にエラーが発生しました。: ${h}`);return}const S=s.get("bname")||"",I=s.get("wname")||"";return h.metadata.setStandardMetadata(T.BLACK_NAME,S),h.metadata.setStandardMetadata(T.WHITE_NAME,I),h}if(!Ge())return;const t=localStorage.getItem(Fe);if(t===null)return;const i=De(t);if(i instanceof Error)return;const r=Number.parseInt(localStorage.getItem(xe)||"0");return i.goto(r),i}function Ls(){return!!new URL(window.location.toString()).searchParams.get("usen")}function ae(s){if(!Ge()||Ls())return;const e=me(s);localStorage.setItem(Fe,e),localStorage.setItem(xe,s.current.ply.toString())}function Gs(){const s=new URL(window.location.toString());s.searchParams.delete("usen"),s.searchParams.delete("branch"),s.searchParams.delete("ply"),s.searchParams.delete("bname"),s.searchParams.delete("wname"),window.history.replaceState({},"",s.toString())}function ke(s){const e=cs(s);return[{type:"list",items:[{text:s.player1.name,children:[`${l.wins}: ${s.player1.win}`]},{text:s.player2.name,children:[`${l.wins}: ${s.player2.win}`]},{text:`${l.draws}: ${s.draw}`},{text:`${l.validGames}: ${s.total-s.invalid}`},{text:`${l.invalidGames}: ${s.invalid}`},{text:`${l.eloRatingDiff} (${l.ignoreDraws})`,children:[`${e.rating.toFixed(2)}`,`95% CI: [${e.ratingLower.toFixed(1)}, ${e.ratingUpper.toFixed(1)}]`]},{text:`${l.eloRatingDiff} (${l.drawCountAsHalfWins})`,children:[`${e.ratingWithDraw.toFixed(2)}`,`95% CI: [${e.ratingWithDrawLower.toFixed(1)}, ${e.ratingWithDrawUpper.toFixed(1)}]`]},{text:"二項検定",children:[`np > 5: ${e.npIsGreaterThan5?"True":"False"}`,`${l.zValue}: ${e.zValue.toFixed(2)}`,`${l.significance5pc}: ${e.significance5pc?"True":"False"}`,`${l.significance1pc}: ${e.significance1pc?"True":"False"}`]}]}]}let Us=class{constructor(){o(this,"recordManager",new Jt(Ds()));o(this,"_appState",n.NORMAL);o(this,"_customLayout",null);o(this,"_isAppSettingsDialogVisible",!1);o(this,"_pvPreview");o(this,"usiMonitor",new ms);o(this,"blackClock",new Pe);o(this,"whiteClock",new Pe);o(this,"gameManager",new hs(this.recordManager,this.blackClock,this.whiteClock));o(this,"csaGameManager",new Es(this.recordManager,this.blackClock,this.whiteClock));o(this,"analysisManager",new ps(this.recordManager));o(this,"mateSearchManager",new Cs);o(this,"_researchState",A.IDLE);o(this,"researchManager",new ws);o(this,"_reactive");o(this,"garbledNotified",!1);o(this,"onChangePositionHandlers",[]);o(this,"onUpdateRecordTreeHandlers",[]);o(this,"onUpdateCustomDataHandlers",[]);const e=ge(this);this._reactive=e,this.recordManager.on("changePosition",()=>{this.onChangePositionHandlers.forEach(t=>t()),ae(this.record),this.updateResearchPosition()}).on("updateTree",()=>{this.onUpdateRecordTreeHandlers.forEach(t=>t()),ae(this.record),Gs()}).on("updateCustomData",()=>{this.onUpdateCustomDataHandlers.forEach(t=>t()),ae(this.record)}).on("backup",()=>({returnCode:p().returnCode})),this.gameManager.on("saveRecord",this.onSaveRecord.bind(e)).on("gameEnd",this.onGameEnd.bind(e)).on("flipBoard",this.onFlipBoard.bind(e)).on("pieceBeat",()=>te(p().pieceVolume)).on("beepShort",this.onBeepShort.bind(e)).on("beepUnlimited",this.onBeepUnlimited.bind(e)).on("stopBeep",Ae).on("error",t=>{R().add(t)}),this.csaGameManager.on("saveRecord",this.onSaveRecord.bind(e)).on("gameEnd",this.onCSAGameEnd.bind(e)).on("flipBoard",this.onFlipBoard.bind(e)).on("pieceBeat",()=>te(p().pieceVolume)).on("beepShort",this.onBeepShort.bind(e)).on("beepUnlimited",this.onBeepUnlimited.bind(e)).on("stopBeep",Ae).on("error",t=>{R().add(t)}),this.researchManager.on("updateSearchInfo",this.onUpdateSearchInfo.bind(e)).on("error",t=>{R().add(t)}),this.analysisManager.on("finish",this.onFinish.bind(e)).on("error",t=>{R().add(t)}),this.mateSearchManager.on("checkmate",this.onCheckmate.bind(e)).on("notImplemented",this.onNotImplemented.bind(e)).on("noMate",this.onNoMate.bind(e)).on("error",this.onCheckmateError.bind(e)),zt(this.updateUSIInfo.bind(e)),Qt(this.updateUSIPonderInfo.bind(e))}addEventListener(e,t){switch(e){case"changePosition":this.onChangePositionHandlers.push(t);break;case"updateRecordTree":this.onUpdateRecordTreeHandlers.push(t);break;case"updateCustomData":this.onUpdateCustomDataHandlers.push(t);break}}removeEventListener(e,t){switch(e){case"changePosition":this.onChangePositionHandlers=this.onChangePositionHandlers.filter(i=>i!==t);break;case"updateRecordTree":this.onUpdateRecordTreeHandlers=this.onUpdateRecordTreeHandlers.filter(i=>i!==t);break;case"updateCustomData":this.onUpdateCustomDataHandlers=this.onUpdateCustomDataHandlers.filter(i=>i!==t);break}}get reactive(){return this._reactive}get record(){return this.recordManager.record}get recordFilePath(){return this.recordManager.recordFilePath}get isRecordFileUnsaved(){return this.recordManager.unsaved}get inCommentPVs(){return this.recordManager.inCommentPVs}updateStandardRecordMetadata(e){this.recordManager.updateStandardMetadata(e)}appendSearchComment(e,t,i,r){this.recordManager.appendSearchComment(e,t,i,r)}appendMovesSilently(e,t){return this.recordManager.appendMovesSilently(e,t)}get appState(){return this._appState}get researchState(){return this._researchState}get customLayout(){return this._customLayout}updateLayoutProfileList(e,t){this._customLayout=t.profiles.find(i=>i.uri===e)||null}get pvPreview(){return this._pvPreview}showPVPreviewDialog(e){this._pvPreview=e}closePVPreviewDialog(){this._pvPreview=void 0}showPasteDialog(){this.appState===n.NORMAL&&(this._appState=n.PASTE_DIALOG)}showGameDialog(){this.appState===n.NORMAL&&(this._appState=n.GAME_DIALOG)}showCSAGameDialog(){this.appState===n.NORMAL&&(this._appState=n.CSA_GAME_DIALOG)}showAnalysisDialog(){this.appState===n.NORMAL&&(this._appState=n.ANALYSIS_DIALOG)}showMateSearchDialog(){this.appState===n.NORMAL&&(this._appState=n.MATE_SEARCH_DIALOG)}showUsiEngineManagementDialog(){this.appState===n.NORMAL&&(this._appState=n.USI_ENGINES_DIALOG)}showRecordFileHistoryDialog(){this.appState===n.NORMAL&&(this._appState=n.RECORD_FILE_HISTORY_DIALOG)}showBatchConversionDialog(){this.appState===n.NORMAL&&(this._appState=n.BATCH_CONVERSION_DIALOG)}showExportBoardImageDialog(){this.appState===n.NORMAL&&(this._appState=n.EXPORT_POSITION_IMAGE_DIALOG)}showLaunchUSIEngineDialog(){this.appState===n.NORMAL&&(this._appState=n.LAUNCH_USI_ENGINE_DIALOG)}showConnectToCSAServerDialog(){this.appState===n.NORMAL&&(this._appState=n.CONNECT_TO_CSA_SERVER_DIALOG)}showLoadRemoteFileDialog(){this.appState===n.NORMAL&&(this._appState=n.LOAD_REMOTE_FILE_DIALOG)}showShareDialog(){this.appState===n.NORMAL&&(this._appState=n.SHARE_DIALOG)}destroyModalDialog(){(this.appState===n.PASTE_DIALOG||this.appState===n.GAME_DIALOG||this.appState===n.CSA_GAME_DIALOG||this.appState===n.ANALYSIS_DIALOG||this.appState===n.MATE_SEARCH_DIALOG||this.appState===n.USI_ENGINES_DIALOG||this.appState===n.EXPORT_POSITION_IMAGE_DIALOG||this.appState===n.RECORD_FILE_HISTORY_DIALOG||this.appState===n.BATCH_CONVERSION_DIALOG||this.appState===n.LAUNCH_USI_ENGINE_DIALOG||this.appState===n.CONNECT_TO_CSA_SERVER_DIALOG||this.appState===n.LOAD_REMOTE_FILE_DIALOG||this.appState===n.SHARE_DIALOG)&&(this._appState=n.NORMAL)}closeModalDialog(){g().isBusy||this.destroyModalDialog()}get isAppSettingsDialogVisible(){return this._isAppSettingsDialogVisible}showAppSettingsDialog(){this._isAppSettingsDialogVisible=!0}closeAppSettingsDialog(){this._isAppSettingsDialogVisible=!1}get usiMonitors(){return this.usiMonitor.sessions}get candidates(){var c;const e=p(),t=100,i=this.recordManager.record.position.sfen,r=[],a=new Set;for(const h of this.usiMonitor.sessions){let S=0,I=-1/0;for(const _ of h.latestIteration){if(S>=e.maxArrowsPerEngine||_.multiPV&&_.multiPV>e.maxArrowsPerEngine)break;if(!((c=_.pv)!=null&&c.length))continue;const v=_.score!==void 0?_.score:_.scoreMate?_.scoreMate>0?1e8-_.scoreMate:-1e8-_.scoreMate:void 0;if(v!==void 0){if(v<I-t)continue;v>I&&(I=v)}const x=_.pv[0];if(a.has(x)||_.position!==i)continue;const $=J.newBySFEN(_.position);if(!$)continue;const L=$.createMoveByUSI(x);!L||!$.doMove(L)||(r.push(L),a.add(x),S++)}}return r}isPausedResearchEngine(e){return this.researchManager.isPaused(e)}pauseResearchEngine(e){this.researchManager.pause(e)}unpauseResearchEngine(e){this.researchManager.unpause(e)}updateUSIInfo(e,t,i,r){if(this.recordManager.record.usi!==t)return;const a=p();this.usiMonitor.update(e,this.recordManager.record.position,i,r,a.maxPVTextLength)}updateUSIPonderInfo(e,t,i,r){const a=U.newByUSI(t);if(a instanceof Error){m.log(b.ERROR,`invalid USI: ${t} (updateUSIPonderInfo)`);return}const c=a.current.move;if(!(c instanceof de))return;const h=p();this.usiMonitor.update(e,a.position,i,r,h.maxPVTextLength,c)}get blackTime(){return this.blackClock.time}get blackByoyomi(){return this.blackClock.byoyomi}get whiteTime(){return this.whiteClock.time}get whiteByoyomi(){return this.whiteClock.byoyomi}startGame(e){this.appState!==n.GAME_DIALOG||g().isBusy||(g().retain(),m.saveGameSettings(e).then(()=>{const t=p(),i=Q(t.engineTimeoutSeconds);return this.gameManager.start(e,i)}).then(()=>this._appState=n.GAME).catch(t=>{R().add("対局の初期化中にエラーが出ました: "+t)}).finally(()=>{g().release()}))}get gameSettings(){return this.gameManager.settings}get gameResults(){return this.gameManager.results}get csaGameState(){return this.csaGameManager.state}get csaServerSessionID(){return this.csaGameManager.sessionID}get csaGameSettings(){return this.csaGameManager.settings}get usiSessionIDs(){return this.appState==n.CSA_GAME?[this.csaGameManager.usiSessionID].filter(e=>e):[]}loginCSAGame(e,t){this.appState!==n.CSA_GAME_DIALOG||g().isBusy||(g().retain(),Promise.resolve().then(async()=>{if(t.saveHistory){const i=await m.loadCSAGameSettingsHistory(),r=It(i,e);await m.saveCSAGameSettingsHistory(r)}}).then(()=>{const i=p(),r=Q(i.engineTimeoutSeconds);return this.csaGameManager.login(e,r)}).then(()=>this._appState=n.CSA_GAME).catch(i=>{R().add("対局の初期化中にエラーが出ました: "+i)}).finally(()=>{g().release()}))}cancelCSAGame(){if(this.appState===n.CSA_GAME){if(this.csaGameManager.state===He.GAME){R().add("対局が始まっているため通信対局をキャンセルできませんでした。");return}this.csaGameManager.logout(),this._appState=n.NORMAL}}stopGame(){switch(this.appState){case n.GAME:this.gameManager.settings.repeat>=2?this.showConfirmation({message:l.areYouSureWantToQuitGames,onOk:()=>this.gameManager.stop()}):this.gameManager.stop();break;case n.CSA_GAME:this.showConfirmation({message:l.areYouSureWantToRequestQuit,onOk:()=>this.csaGameManager.stop()});break}}showGameResults(){if(this.appState!==n.GAME)return;const e=this.gameManager.results;k().enqueue({text:l.gameProgress,attachments:ke(e)})}onGameEnd(e,t){this.appState===n.GAME&&(m.log(b.INFO,`game end: ${JSON.stringify(e)}`),e&&e.total>=2?k().enqueue({text:l.allGamesCompleted,attachments:ke(e)}):t&&k().enqueue({text:`${l.gameEnded}（${_t(t)})`}),this._appState=n.NORMAL)}onCSAGameEnd(){this.appState===n.CSA_GAME&&(this._appState=n.NORMAL)}onFlipBoard(e){p().boardFlipping!==e&&p().flipBoard()}onSaveRecord(){const e=p(),t=_e(this.recordManager.record.metadata,e.recordFileNameTemplate,e.defaultRecordFileFormat),i=Mt(e.autoSaveDirectory,t);this.saveRecordByPath(i).catch(r=>{R().add(r)})}onBeepShort(){const e=p();e.clockSoundTarget===Me.ONLY_USER&&!this.isMovableByUser||wt({frequency:e.clockPitch,volume:e.clockVolume})}onBeepUnlimited(){const e=p();e.clockSoundTarget===Me.ONLY_USER&&!this.isMovableByUser||Ct({frequency:e.clockPitch,volume:e.clockVolume})}doMove(e){if(this.appState!==n.NORMAL||!this.recordManager.appendMove({move:e}))return;const t=p();te(t.pieceVolume)}onFinish(){this.appState===n.ANALYSIS&&(k().enqueue({text:"棋譜解析が終了しました。"}),this._appState=n.NORMAL)}showResearchDialog(){this._researchState===A.IDLE&&(this._researchState=A.STARTUP_DIALOG)}closeResearchDialog(){this._researchState===A.STARTUP_DIALOG&&(this._researchState=A.IDLE)}startResearch(e){if(!(this._researchState!==A.STARTUP_DIALOG||g().isBusy)){if(g().retain(),!e.usi){R().add(new Error("エンジンが設定されていません。"));return}m.saveResearchSettings(e).then(()=>this.researchManager.launch(e)).then(()=>{this._researchState=A.RUNNING,this.updateResearchPosition();const t=p();t.tab!==w.SEARCH&&t.tab!==w.PV&&t.tab!==w.CHART&&t.tab!==w.PERCENTAGE_CHART&&t.tab!==w.MONITOR&&p().updateAppSettings({tab:w.PV})}).catch(t=>{R().add("検討の初期化中にエラーが出ました: "+t)}).finally(()=>{g().release()})}}stopResearch(){this._researchState===A.RUNNING&&(this.researchManager.close(),this._researchState=A.IDLE)}isResearchEngineSessionID(e){return this.researchManager.isSessionExists(e)}onUpdateSearchInfo(e,t){this.recordManager.updateSearchInfo(e,t)}startAnalysis(e){this.appState!==n.ANALYSIS_DIALOG||g().isBusy||(g().retain(),m.saveAnalysisSettings(e).then(()=>this.analysisManager.start(e)).then(()=>{this._appState=n.ANALYSIS}).catch(t=>{R().add("検討の初期化中にエラーが出ました: "+t)}).finally(()=>{g().release()}))}stopAnalysis(){this.appState===n.ANALYSIS&&(this.analysisManager.close(),this._appState=n.NORMAL)}startMateSearch(e){if(!(this.appState!==n.MATE_SEARCH_DIALOG||g().isBusy)){if(g().retain(),!e.usi){R().add(new Error("エンジンが設定されていません。"));return}m.saveMateSearchSettings(e).then(()=>this.mateSearchManager.start(e,this.recordManager.record)).then(()=>{this._appState=n.MATE_SEARCH;const t=p();t.tab!==w.SEARCH&&t.tab!==w.PV&&p().updateAppSettings({tab:w.SEARCH})}).catch(t=>{R().add("詰将棋探索の初期化中にエラーが出ました: "+t)}).finally(()=>{g().release()})}}stopMateSearch(){this.appState===n.MATE_SEARCH&&(this.mateSearchManager.close(),this._appState=n.NORMAL)}onCheckmate(e){if(this.appState!==n.MATE_SEARCH)return;this._appState=n.NORMAL;const t=this.recordManager.record.position;this.showConfirmation({message:l.mateInNPlyDoYouWantToDisplay(e.length),onOk:()=>{this.showPVPreviewDialog({position:t,mate:e.length,pv:e})}})}onNotImplemented(){this.appState===n.MATE_SEARCH&&(R().add(new Error(l.thisEngineNotSupportsMateSearch)),this._appState=n.NORMAL)}onNoMate(){this.appState===n.MATE_SEARCH&&(k().enqueue({text:l.noMateFound}),this._appState=n.NORMAL)}onCheckmateError(e){this.appState===n.MATE_SEARCH&&(R().add(e),this._appState=n.NORMAL)}updateResearchPosition(){var e;(e=this.researchManager)==null||e.updatePosition(this.recordManager.record)}resetRecord(){this.appState==n.NORMAL&&this.showConfirmation({message:l.areYouSureWantToClearRecord,onOk:()=>{this.recordManager.reset()}})}updateRecordComment(e){this.recordManager.updateComment(e)}updateRecordBookmark(e){this.recordManager.updateBookmark(e)}insertSpecialMove(e){this.appState===n.NORMAL&&this.recordManager.appendMove({move:e})}startPositionEditing(){this.appState===n.NORMAL&&this.showConfirmation({message:l.areYouSureWantToClearRecord,onOk:()=>{this._appState=n.POSITION_EDITING,this.recordManager.resetByCurrentPosition()}})}endPositionEditing(){this.appState===n.POSITION_EDITING&&(this._appState=n.NORMAL)}initializePositionBySFEN(e){(this.appState===n.NORMAL||this.appState===n.POSITION_EDITING)&&this.showConfirmation({message:this.appState===n.NORMAL?l.areYouSureWantToClearRecord:l.areYouSureWantToDiscardPosition,onOk:()=>{this.recordManager.resetBySFEN(e)}})}changeTurn(){this.appState==n.POSITION_EDITING&&this.recordManager.swapNextTurn()}showPieceSetChangeDialog(){this.appState===n.POSITION_EDITING&&(this._appState=n.PIECE_SET_CHANGE_DIALOG)}closePieceSetChangeDialog(e){this.appState===n.PIECE_SET_CHANGE_DIALOG&&(e&&this.recordManager.changePieceSet(e),this._appState=n.POSITION_EDITING)}editPosition(e){this.appState===n.POSITION_EDITING&&this.recordManager.changePosition(e)}goForward(){this.appState===n.NORMAL&&this.recordManager.goForward()}goBack(){this.appState===n.NORMAL&&this.recordManager.goBack()}changePly(e){this.appState===n.NORMAL&&this.recordManager.changePly(e)}changeBranch(e){this.appState===n.NORMAL&&this.recordManager.changeBranch(e)}swapWithNextBranch(){return this.recordManager.swapWithNextBranch()}swapWithPreviousBranch(){return this.recordManager.swapWithPreviousBranch()}removeCurrentMove(){if(this.appState===n.NORMAL){if(this.recordManager.record.current.isLastMove){this.recordManager.removeCurrentMove();return}this.showConfirmation({message:l.areYouSureWantToDeleteFollowingMove(this.recordManager.record.current.ply),onOk:()=>{this.recordManager.removeCurrentMove()}})}}jumpToBookmark(e){return this.appState===n.NORMAL?this.recordManager.jumpToBookmark(e):!1}copyRecordKIF(){const e=p(),t=me(this.recordManager.record,{returnCode:e.returnCode});navigator.clipboard.writeText(t)}copyRecordKI2(){const e=p(),t=yt(this.recordManager.record,{returnCode:e.returnCode});navigator.clipboard.writeText(t)}copyRecordCSA(){const e=p(),t=Tt(this.recordManager.record,{returnCode:e.returnCode,v3:e.useCSAV3?{milliseconds:!0}:void 0});navigator.clipboard.writeText(t)}copyRecordUSIBefore(){const e=p(),t=this.recordManager.record.getUSI({startpos:e.enableUSIFileStartpos,resign:e.enableUSIFileResign});navigator.clipboard.writeText(t)}copyRecordUSIAll(){const e=p(),t=this.recordManager.record.getUSI({startpos:e.enableUSIFileStartpos,resign:e.enableUSIFileResign,allMoves:!0});navigator.clipboard.writeText(t)}copyBoardSFEN(){const e=this.recordManager.record.sfen;navigator.clipboard.writeText(e)}copyRecordJKF(){const e=bt(this.recordManager.record);navigator.clipboard.writeText(e)}copyRecordUSEN(){const[e]=this.recordManager.record.usen;navigator.clipboard.writeText(e)}pasteRecord(e){if(this.appState!==n.NORMAL)return;const t=this.recordManager.importRecord(e);if(t){R().add(t);return}}openRecord(e,t){if(this.appState!==n.NORMAL||g().isBusy){R().add(l.pleaseEndActiveFeaturesBeforeOpenRecord);return}g().retain(),Promise.resolve().then(()=>e||m.showOpenRecordDialog()).then(i=>{if(!i)return;const a=p().textDecodingRule==At.AUTO_DETECT;return m.openRecord(i).then(c=>{const h=this.recordManager.importRecordFromBuffer(c,i,{autoDetect:a});return h&&Promise.reject(h)})}).then(()=>{t!=null&&t.ply&&this.recordManager.changePly(t.ply)}).catch(i=>{R().add("棋譜の読み込み中にエラーが出ました: "+i)}).finally(()=>{g().release()})}saveRecord(e){this.appState!==n.NORMAL||g().isBusy||(g().retain(),Promise.resolve().then(()=>{const t=this.recordManager.recordFilePath;if(e!=null&&e.overwrite&&t)return t;const i=p(),r=!(e!=null&&e.format)&&t||_e(this.recordManager.record.metadata,i.recordFileNameTemplate,(e==null?void 0:e.format)||i.defaultRecordFileFormat);return m.showSaveRecordDialog(r)}).then(t=>{if(t)return this.saveRecordByPath(t,{detectGarbled:!0}).then(()=>{const i=ce(t),r=Os(this.recordManager.record,i),a=Object.entries(r).filter(([,c])=>c).map(([c])=>{switch(c){case"branch":return l.branches;case"comment":return l.comments;case"bookmark":return l.bookmark;case"time":return l.elapsedTime}}).map(c=>({text:c}));a.length&&k().enqueue({text:l.followingDataNotSavedBecauseNotSupporetedBy(i),attachments:[{type:"list",items:a}]})})}).catch(t=>{R().add(t)}).finally(()=>{g().release()}))}async saveRecordByPath(e,t){const i=p(),r=this.recordManager.exportRecordAsBuffer(e,{returnCode:i.returnCode,detectGarbled:t==null?void 0:t.detectGarbled,csa:{v3:i.useCSAV3}});if(r instanceof Error)throw r;try{await m.saveRecord(e,r.data),r.garbled&&!this.garbledNotified&&(k().enqueue({text:`${l.recordSavedWithGarbledCharacters}
${l.pleaseConsiderToUseKIFU}
${l.youCanChangeDefaultRecordFileFormatFromAppSettings}`}),this.garbledNotified=!0)}catch(a){throw new Error(`${l.failedToSaveRecord}: ${a}`)}}restoreFromBackup(e){this.appState!==n.RECORD_FILE_HISTORY_DIALOG||g().isBusy||(g().retain(),m.loadRecordFileBackup(e).then(t=>{const i=this.recordManager.importRecord(t,{type:P.KIF,markAsSaved:!0});if(i)return Promise.reject(i);this._appState=n.NORMAL}).catch(t=>{R().add(t)}).finally(()=>{g().release()}))}get remoteRecordFileURL(){return this.recordManager.sourceURL}loadRemoteRecordFile(e){g().retain(),this.recordManager.importRecordFromRemoteURL(e).catch(t=>R().add(t)).finally(()=>g().release())}showJishogiPoints(){const e=this.recordManager.record.position,t=ye(e,f.BLACK),i=Te(e,f.BLACK),r=W(F.GENERAL24,e,f.BLACK),a=W(F.GENERAL27,e,f.BLACK),c=ye(e,f.WHITE),h=Te(e,f.WHITE),S=W(F.GENERAL24,e,f.WHITE),I=W(F.GENERAL27,e,f.WHITE);k().enqueue({text:l.jishogiPoints,attachments:[{type:"list",items:[{text:l.sente,children:[`Points (Total): ${t}`,`Points (Declaration): ${i}`,`Rule-24: ${r.toUpperCase()}`,`Rule-27: ${a.toUpperCase()}`]},{text:l.gote,children:[`Points (Total): ${c}`,`Points (Declaration): ${h}`,`Rule-24: ${S.toUpperCase()}`,`Rule-27: ${I.toUpperCase()}`]}]}]})}get isMovableByUser(){switch(this.appState){case n.NORMAL:return!0;case n.GAME:return(this.recordManager.record.position.color===f.BLACK?this.gameManager.settings.black.uri:this.gameManager.settings.white.uri)===le;case n.CSA_GAME:return this.csaGameManager.isMyTurn&&this.csaGameManager.settings.player.uri===le}return!1}async onMainWindowClose(){g().retain();try{await this.recordManager.saveBackup()}finally{g().release()}}showConfirmation(e){const t=this.appState;q().show({...e,onOk:()=>{if(this.appState!==t){R().add("確認ダイアログ表示中に他の操作が行われたため処理が中止されました。");return}e.onOk()}})}};function Bs(){return new Us().reactive}let oe;function Hs(){return oe||(oe=Bs()),oe}var Fs=(s=>(s.CSA="csa",s.USI="usi",s))(Fs||{}),$e=(s=>(s.SEND="send",s.RECEIVE="receive",s.SYSTEM="system",s))($e||{});function xs(s,e){const t=new Date;return{type:s,command:e,dateTime:Nt(t),timeMs:t.getTime()}}function $s(s,e,t,i){Array.isArray(e)||(e=[e]);for(const r of e)s.commands.push(r);if(s.commands.length>t){const r=Math.max(i,s.commands.length-t);s.discarded+=r,s.commands.splice(0,r)}}class Ws{constructor(){o(this,"_reactive");o(this,"_target");o(this,"_sessionID");o(this,"_name");o(this,"_history",{discarded:0,commands:[]});o(this,"_nextID",0);o(this,"buffer",[]);o(this,"bufferTimer",null);this._reactive=ge(this);const e=new URL(window.location.toString()).searchParams;this._target=e.get("target"),this._sessionID=Number(e.get("session")),this._name=e.get("name")||"unknown"}get reactive(){return this._reactive}get target(){return this._target}get sessionID(){return this._sessionID}get name(){return this._name}get history(){return this._history}async setup(){try{const e=await m.setupPrompt(this.target,this.sessionID);this._history={discarded:e.discarded,commands:e.commands.map(t=>({...t,id:this._nextID++}))}}catch(e){this.onError(e)}}onCommand(e){this.buffer.push({...e,id:this._nextID++}),!this.bufferTimer&&(this.bufferTimer=window.setTimeout(()=>{$s(this._history,this.buffer,1e3,100),this.buffer=[],this.bufferTimer=null},250))}onError(e){this.onCommand(xs($e.SYSTEM,`Failed to load command history: ${this.target}: ${this.sessionID}: ${e}`))}invokeCommand(e,t){m.invokePromptCommand(this.target,this.sessionID,e,t)}}function Vs(){return new Ws().reactive}let ne;function Ys(){return ne||(ne=Vs()),ne}var d=(s=>(s.NEW_RECORD="newRecord",s.OPEN_RECORD="openRecord",s.SAVE_RECORD="saveRecord",s.SAVE_RECORD_AS="saveRecordAs",s.HISTORY="history",s.LOAD_REMOTE_RECORD="loadRemoteRecord",s.BATCH_CONVERSION="batchConversion",s.SHARE="share",s.EXPORT_POSITION_IMAGE="exportPositionImage",s.COPY_RECORD="copyRecord",s.COPY_RECORD_KI2="copyRecordKi2",s.COPY_RECORD_CSA="copyRecordCsa",s.COPY_RECORD_USI_BEFORE="copyRecordUsiBefore",s.COPY_RECORD_USI_ALL="copyRecordUsiAll",s.COPY_RECORD_JKF="copyRecordJkf",s.COPY_RECORD_USEN="copyRecordUsen",s.COPY_BOARD_SFEN="copyRecordSfen",s.PASTE_RECORD="pasteRecord",s.INSERT_INTERRUPT="insertInterrupt",s.INSERT_RESIGN="insertResign",s.INSERT_DRAW="insertDraw",s.INSERT_IMPASS="insertImpass",s.INSERT_REPETITION_DRAW="insertRepetitionDraw",s.INSERT_MATE="insertMate",s.INSERT_NO_MATE="insertNoMate",s.INSERT_TIMEOUT="insertTimeout",s.INSERT_FOUL_WIN="insertFoulWin",s.INSERT_FOUL_LOSE="insertFoulLose",s.INSERT_ENTERING_OF_KING="insertEnteringOfKing",s.INSERT_WIN_BY_DEFAULT="insertWinByDefault",s.INSERT_LOSE_BY_DEFAULT="insertLossByDefault",s.REMOVE_CURRENT_MOVE="remvoeCurrentMove",s.START_POSITION_EDITING="startPositionEditing",s.END_POSITION_EDITING="endPositionEditing",s.CHANGE_TURN="changeTurn",s.INIT_POSITION="initPosition",s.START_RESEARCH="startResearch",s.STOP_RESEARCH="stopResearch",s.START_ANALYSIS="startAnalysis",s.STOP_ANALYSIS="stopAnalysis",s.START_MATE_SEARCH="startMateSearch",s.STOP_MATE_SEARCH="stopMateSearch",s.START_GAME="startGame",s.START_CSA_GAME="startCSAGame",s.STOP_GAME="stopGame",s.RESIGN="resign",s.WIN="win",s.LOGOUT="logout",s.CALCULATE_POINTS="calculateJishogiPoints",s.FLIP_BOARD="flipBoard",s.APP_SETTINGS_DIALOG="appSettings",s.USI_ENGINES_DIALOG="usiEngines",s.LAUNCH_USI_ENGINE="launchUsiEngine",s.CONNECT_TO_CSA_SERVER="connectToCsaServer",s))(d||{});function js(){const s=Hs(),e=p(),t=g();vt(()=>[s.appState,s.researchState,t.isBusy],([i,r,a])=>E.updateAppState(i,r,a)),E.updateAppState(s.appState,s.researchState,t.isBusy),E.onClose(()=>{s.onMainWindowClose().catch(i=>{E.log(b.ERROR,i.message)}).finally(()=>{E.onClosable()})}),E.onSendError(i=>{R().add(i)}),E.onMenuEvent((i,...r)=>{if(!t.isBusy)switch(i){case d.NEW_RECORD:s.resetRecord();break;case d.OPEN_RECORD:s.openRecord();break;case d.SAVE_RECORD:s.saveRecord({overwrite:!0});break;case d.SAVE_RECORD_AS:s.saveRecord();break;case d.HISTORY:s.showRecordFileHistoryDialog();break;case d.LOAD_REMOTE_RECORD:s.showLoadRemoteFileDialog();break;case d.BATCH_CONVERSION:s.showBatchConversionDialog();break;case d.SHARE:s.showShareDialog();break;case d.EXPORT_POSITION_IMAGE:s.showExportBoardImageDialog();break;case d.COPY_RECORD:s.copyRecordKIF();break;case d.COPY_RECORD_KI2:s.copyRecordKI2();break;case d.COPY_RECORD_CSA:s.copyRecordCSA();break;case d.COPY_RECORD_USI_BEFORE:s.copyRecordUSIBefore();break;case d.COPY_RECORD_USI_ALL:s.copyRecordUSIAll();break;case d.COPY_RECORD_JKF:s.copyRecordJKF();break;case d.COPY_RECORD_USEN:s.copyRecordUSEN();break;case d.COPY_BOARD_SFEN:s.copyBoardSFEN();break;case d.PASTE_RECORD:s.showPasteDialog();break;case d.INSERT_INTERRUPT:s.insertSpecialMove(u.INTERRUPT);break;case d.INSERT_RESIGN:s.insertSpecialMove(u.RESIGN);break;case d.INSERT_DRAW:s.insertSpecialMove(u.DRAW);break;case d.INSERT_IMPASS:s.insertSpecialMove(u.IMPASS);break;case d.INSERT_REPETITION_DRAW:s.insertSpecialMove(u.REPETITION_DRAW);break;case d.INSERT_MATE:s.insertSpecialMove(u.MATE);break;case d.INSERT_NO_MATE:s.insertSpecialMove(u.NO_MATE);break;case d.INSERT_TIMEOUT:s.insertSpecialMove(u.TIMEOUT);break;case d.INSERT_FOUL_WIN:s.insertSpecialMove(u.FOUL_WIN);break;case d.INSERT_FOUL_LOSE:s.insertSpecialMove(u.FOUL_LOSE);break;case d.INSERT_ENTERING_OF_KING:s.insertSpecialMove(u.ENTERING_OF_KING);break;case d.INSERT_WIN_BY_DEFAULT:s.insertSpecialMove(u.WIN_BY_DEFAULT);break;case d.INSERT_LOSE_BY_DEFAULT:s.insertSpecialMove(u.LOSE_BY_DEFAULT);break;case d.REMOVE_CURRENT_MOVE:s.removeCurrentMove();break;case d.START_POSITION_EDITING:s.startPositionEditing();break;case d.END_POSITION_EDITING:s.endPositionEditing();break;case d.CHANGE_TURN:s.changeTurn();break;case d.INIT_POSITION:s.initializePositionBySFEN(r[0]);break;case d.START_MATE_SEARCH:s.showMateSearchDialog();break;case d.STOP_MATE_SEARCH:s.stopMateSearch();break;case d.START_GAME:s.showGameDialog();break;case d.START_CSA_GAME:s.showCSAGameDialog();break;case d.STOP_GAME:s.stopGame();break;case d.RESIGN:if(!s.isMovableByUser)break;q().show({message:l.areYouSureWantToResign,onOk:()=>{ue.resign()}});break;case d.WIN:if(!s.isMovableByUser)break;q().show({message:l.areYouSureWantToDoDeclaration,onOk:()=>{ue.win()}});break;case d.LOGOUT:s.cancelCSAGame();break;case d.CALCULATE_POINTS:s.showJishogiPoints();break;case d.START_RESEARCH:s.showResearchDialog();break;case d.STOP_RESEARCH:s.stopResearch();break;case d.START_ANALYSIS:s.showAnalysisDialog();break;case d.STOP_ANALYSIS:s.stopAnalysis();break;case d.FLIP_BOARD:p().flipBoard();break;case d.APP_SETTINGS_DIALOG:s.showAppSettingsDialog();break;case d.USI_ENGINES_DIALOG:s.showUsiEngineManagementDialog();break;case d.LAUNCH_USI_ENGINE:s.showLaunchUSIEngineDialog();break;case d.CONNECT_TO_CSA_SERVER:s.showConnectToCSAServerDialog();break}}),E.onUpdateAppSettings(i=>{e.updateAppSettings(JSON.parse(i))}),E.onOpenRecord(i=>{q().show({message:l.areYouSureWantToOpenFileInsteadOfCurrentRecord,onOk:()=>{s.openRecord(i)}})}),E.onUSIBestMove(Xt),E.onUSICheckmate(Zt),E.onUSICheckmateNotImplemented(es),E.onUSICheckmateTimeout(ts),E.onUSINoMate(ss),E.onUSIInfo((i,r,a)=>{const c=JSON.parse(a);is(i,r,c)}),E.onUSIPonderInfo((i,r,a)=>{const c=JSON.parse(a);rs(i,r,c)}),E.onCSAGameSummary((i,r)=>{_s(i,JSON.parse(r))}),E.onCSAReject(Ms),E.onCSAStart((i,r)=>{ys(i,JSON.parse(r))}),E.onCSAMove((i,r,a)=>{Ts(i,r,JSON.parse(a))}),E.onCSAGameResult(bs),E.onCSAClose(As),E.onUpdateLayoutProfileList((i,r)=>{s.updateLayoutProfileList(i,JSON.parse(r))})}function zs(){const s=Ys();E.onPromptCommand(e=>{s.onCommand(JSON.parse(e))})}export{n as A,He as C,Ns as L,Fs as P,A as R,M as S,us as U,g as a,js as b,Ys as c,$e as d,zs as e,ue as h,fs as l,Ne as s,Hs as u};
